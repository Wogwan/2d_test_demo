clear;tic;
pvar x1 x2 u htol epsi;
x = [x1;x2];
dom = 10;
%%
% V = 0.04179276814237692*x1^4+0.00599499247615957*x1^3*x2-0.01159727730969628*x1^2*x2^2+0.1133535410885831*x1*x2^3+0.1278491306857938*x2^4-0.02172406709266159*x1^3-0.01538819184502436*x1^2*x2-0.0696562899336908*x1*x2^2-0.06418623865759861*x2^3+1.008634051772913*x1^2-0.1426054475471644*x1*x2+1.639478142955251*x2^2+0.0001459131173134332*x1+0.0002096383926257461*x2+16.81346393865286;
% C0 = 36.684617121664921; 
% k_u = 4; k_h = 4; L_us = 4; L_au = 2; gamma = 0;

% V = 0.01432796979173342*x1^6+0.01307239568384647*x1^5*x2+0.02000129261541955*x1^4*x2^2+0.03861063008812927*x1^3*x2^3+0.06517847700768792*x1^2*x2^4+0.07079844786501621*x1*x2^5+0.04747235390235857*x2^6-0.01297287638876785*x1^5-0.01148662882596332*x1^4*x2-0.04286292442358448*x1^3*x2^2-0.07928722715442263*x1^2*x2^3-0.04928460864427874*x1*x2^4-0.001581361461956942*x2^5+1.092341753734699*x1^4+0.1364303543026367*x1^3*x2+0.362085704193934*x1^2*x2^2+1.689588606272371*x1*x2^3+2.450687111224395*x2^4-0.3103130790968259*x1^3-0.3820998934834934*x1^2*x2-2.009911107645158*x1*x2^2-0.3836344771128852*x2^3-2.1568585663621*x1^2-1.708074486238783*x1*x2+0.5129620338042835*x2^2+1.698364731468921*x1-1.099657431236194*x2+58.45941815854732;
% C0 = 1e+2*2.402239098825560; 
% k_u = 8; k_h = 8; L_us = 8; L_au = 4; gamma = 0;

%% Target
% V = 0.01138889363008043*x1^4+0.004827148264306236*x1^3*x2-0.003903524950223082*x1^2*x2^2+0.03633423007547412*x1*x2^3+0.04015007648131837*x2^4-0.005241906490698128*x1^3-0.004751139945651724*x1^2*x2-0.02274348053900107*x1*x2^2-0.02502859648976924*x2^3+0.7253354387210329*x1^2-0.1563363728124071*x1*x2+1.195176126742885*x2^2-0.5025797466190337*x1-0.1846802198553966*x2+2.416049660876682;
% C0 = 12.774854575233798; 
% k_u = 4; k_h = 4; L_us = 4; L_au = 4; gamma = 0;

%% Target test
% V = 0.01138889363008043*x1^4+0.004827148264306236*x1^3*x2-0.003903524950223082*x1^2*x2^2+0.03633423007547412*x1*x2^3+0.04015007648131837*x2^4-0.005241906490698128*x1^3-0.004751139945651724*x1^2*x2-0.02274348053900107*x1*x2^2-0.02502859648976924*x2^3+0.7253354387210329*x1^2-0.1563363728124071*x1*x2+1.195176126742885*x2^2-0.5025797466190337*x1-0.1846802198553966*x2+2.416049660876682;
% C0 = 12.774854575233798; 
% k_u = 6; k_h = 6; L_us = 6; L_au = 6; gamma = 0;

%%
V = 0.01321546658266978*x1^6+0.009526123062462689*x1^5*x2+0.02585071106111556*x1^4*x2^2+0.02986537136053708*x1^3*x2^3+0.04763167458814371*x1^2*x2^4+0.06541562708213533*x1*x2^5+0.05346674773666403*x2^6-0.009344331823663845*x1^5+0.01148832416157716*x1^4*x2-0.01758526989303658*x1^3*x2^2-0.05226914314453938*x1^2*x2^3-0.009364086086940513*x1*x2^4+0.02299853163143772*x2^5+1.790269906159561*x1^4+0.1987111898099446*x1^3*x2+0.3648383406985133*x1^2*x2^2+2.969873199748214*x1*x2^3+4.302325107540098*x2^4-0.6342650784489438*x1^3-0.2363579357147753*x1^2*x2-3.077022322113091*x1*x2^2-0.9893321718513352*x2^3+0.8482791181500139*x1^2-0.2593893289298875*x1*x2+1.67230152127387*x2^2+0.0001076786046864902*x1+0.0001980400265510114*x2+69.99362647420185;
C0 = 1e+2*3.766420325583902; 
k_u = 8; k_h = 8; L_us = 8; L_au = 8; gamma = 0;

%%
sol_B = C0 - V; solh = sol_B;
f = [x2-x1
    -0.23606416828637188828796009029584*x1^4+0.24650838581310801777701368775053*x1^3+x1^2*x2-0.7173309565565305634393666878168*x1^2+0.26453823849708858750862106035129*x1+0.03729676680157056195552556232542*x2^4+0.01893812978180069162004173222158*x2^3+0.13680422363948308017711497086566*x2^2+0.043563863537901807709840085180986*x2+0.23883336887991710173473336453753
    ];
gg = [1;1];
C1 = (x1+4)^2+(x2-6)^2-4;
C2 = (x1+3)^2+(x2+4)^2-4;
C3 = (x1-6)^2+(x2-0)^2-5;
C = [C1;C2;C3]; % C = [C1;C2];
trace_Q1 = 1; trace_Q = 0; mm = 0; kk = 1; i = 0;
%%
figure_id = 12; figure(figure_id);clf;hold on;
domain = [-dom dom -dom dom]; xlim([-dom dom]); ylim([-dom dom]); hold on;
[~,~]=pcontour(V,C0,domain,'b'); hold on;  
[~,~]=pcontour(C1,0,domain,'k'); hold on;           
[~,~]=pcontour(C2,0,domain,'k'); hold on;         
if length(C) == 3
    [~,~]=pcontour(C(3),0,domain,'r');            % Plot the original Lyapunov sublevel set
end      
axis(domain); TRACE = []; Barrier = []; Control = [];
%%
while 1
    i = i+1
    record_Q = trace_Q
    %%
    [SOLu1,SOLu2,SOL1,SOL2,kk] = sos_function_1(f,k_u,L_au,solh,V,gamma,gg);
    if kk == 0
        break
    end
    Control = [Control; [SOLu1 SOLu2]];
    %%
%     [solh,trace_Q,kk]=sos_function_2(i,f,k_h,SOLu1,SOLu2,SOL1,SOL2,gamma,V,C,dom,gg,L_us,sol_B);
    [solh,trace_Q,kk] = sos_function_2(i,f,k_h,SOLu1,SOLu2,SOL1,SOL2,gamma,V,C,dom,gg,L_us,figure_id);
    if kk == 0
        break
    end
    TRACE = [TRACE; double(trace_Q)];
    Barrier = [Barrier; solh];
end