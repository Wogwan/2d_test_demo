figure(99999999);clf;
view(-150, 30);hold on;
%%
pvar x1 x2 x3;
%% Unsafe regions
C1 = (x1+4)^2+(x2-6)^2+(x3+2)^2-4;
C2 = (x1+3)^2+(x2+4)^2+(x3+4)^2-4;
C3 = (x1-4)^2+(x2-0)^2+(x3-0)^2-5;
C4 = (x1+4)^2+(x2-2)^2+(x3-4)^2-5;
%% Initial Barrier function with autonomous system
B_0 = -926163.9939077364*x1^6+257027.8194382421*x1^5*x2+1114280.643786584*x1^5*x3+201240.346766742*x1^4*x2^2-263537.4669273091*x1^4*x2*x3-1410172.924076108*x1^4*x3^2-620021.4707155579*x1^3*x2^3-470731.5188031173*x1^3*x2^2*x3+317313.2904248089*x1^3*x2*x3^2+87524.32825363729*x1^3*x3^3-1750806.968972303*x1^2*x2^4+11797.01047546853*x1^2*x2^3*x3+1885958.774594082*x1^2*x2^2*x3^2-15661.03621528457*x1^2*x2*x3^3-2658944.807774647*x1^2*x3^4+161311.6659057942*x1*x2^5+1720917.65384088*x1*x2^4*x3+33510.17871710166*x1*x2^3*x3^2-548727.4794381509*x1*x2^2*x3^3-283738.5365229551*x1*x2*x3^4-1419784.451496469*x1*x3^5-142597.4104408523*x2^6+52138.6132987351*x2^5*x3-163184.3653689249*x2^4*x3^2+166950.0761301221*x2^3*x3^3-566806.182745123*x2^2*x3^4-239442.1396904833*x2*x3^5-642690.1133243747*x3^6-696830.9098147663*x1^5+330862.4377695156*x1^4*x2+1807509.806103987*x1^4*x3+837267.4911669964*x1^3*x2^2-23873.92242735565*x1^3*x2*x3+1170593.804869505*x1^3*x3^2-518019.1556930111*x1^2*x2^3+65372.33762398906*x1^2*x2^2*x3+445767.6496450633*x1^2*x2*x3^2+2459826.248696288*x1^2*x3^3-3245365.199848898*x1*x2^4-358203.7729891831*x1*x2^3*x3+1662729.359506953*x1*x2^2*x3^2-176631.4041140994*x1*x2*x3^3-4342254.528352661*x1*x3^4+19659.23283137218*x2^5+2043286.429218962*x2^4*x3+78317.54957940077*x2^3*x3^2-1414691.956066933*x2^2*x3^3-295160.6190596161*x2*x3^4-1330259.439048674*x3^5-832587.9732691126*x1^4-63982.40805285073*x1^3*x2-1200522.69071716*x1^3*x3+1180223.636218488*x1^2*x2^2+540692.9352467548*x1^2*x2*x3+8238006.592535419*x1^2*x3^2+502486.5898205069*x1*x2^3+2340828.244666143*x1*x2^2*x3+292984.6384099874*x1*x2*x3^2+4250629.284472954*x1*x3^3-1910669.519192282*x2^4-585297.0300103959*x2^3*x3+1328395.139199292*x2^2*x3^2+122192.1497847754*x2*x3^3-1243560.679877585*x3^4-1099835.963070786*x1^3-641480.9197385721*x1^2*x2-6280329.881647754*x1^2*x3-1015385.743818734*x1*x2^2+706630.9776949236*x1*x2*x3+5693445.394214684*x1*x3^2+593160.1654524104*x2^3+2109817.351721545*x2^2*x3+149805.8508851641*x2*x3^2+2589330.924597146*x3^3-199481.3337080848*x1^2-738979.0011165645*x1*x2-6346397.498020018*x1*x3-1108576.644199351*x2^2+343716.3917563515*x2*x3+726243.6550288534*x3^2+1496846.595672866*x1-309236.6831834472*x2-2509456.197763228*x3+411103.3481464338;
%% Initial Lyapunov function
V0 = 10*x1^4+1*x2^4+20*x3^4+2*x1^2*x2^2-4*x3^2*x2^2+3*x1^2*x3^2;
C0 = 5e-3;
%% Sublevel set of V0
C = 96.811595465770495;
%% Optimal CBF
B_1 = - 273.39650242684382419611210934818*x1^4 + 3.2589263027938537575778354948852*x1^3*x2 + 3.3562511580000289335146135272225*x1^3*x3 - 0.015310159136399738993850050405854*x1^3 + 49.560606565764210529323463561013*x1^2*x2^2 - 5.6863118500645093433831789297983*x1^2*x2*x3 - 1.839760885155375058630511375668*x1^2*x2 + 492.75971320250397411655285395682*x1^2*x3^2 - 1.5992531329666697104130435036495*x1^2*x3 - 0.06476811099359396084462758835798*x1^2 - 4.4810995274363758511526611982845*x1*x2^3 - 4.1790204996910276236121717374772*x1*x2^2*x3 + 1.897106711113640820087766769575*x1*x2^2 + 1.9410588550273071284379966527922*x1*x2*x3^2 + 4.6231191532671704891299668815918*x1*x2*x3 + 0.178092708725241050116139263082*x1*x2 + 1.5480254619169324659111453001969*x1*x3^3 + 2.7257282965782598793680335802492*x1*x3^2 + 0.12158874575605656265242515701175*x1*x3 - 0.000081013903294964385772697346155269*x1 - 16.986346934193537805413143360056*x2^4 + 2.7918880650780653063236513844458*x2^3*x3 + 1.7519110948437255359522168873809*x2^3 - 16.66612225822484916193388926331*x2^2*x3^2 + 1.182358264011557746897551623988*x2^2*x3 - 0.87342702549842854420347748600761*x2^2 - 3.6388353511441993148878282227088*x2*x3^3 - 0.58096981620094623188776949973544*x2*x3^2 - 0.69804408467847633978919930086704*x2*x3 + 0.000012981585341486740300303084905131*x2 - 241.85695481156326991367677692324*x3^4 - 0.27175859700355692316620093151869*x3^3 - 0.16597403855979686593258293214603*x3^2 + 0.000041307146010535933280515691334855*x3 + 694.5013932663647437948384322226;
%% New Lyapunov function
V = 0.6208611094349646*x1^4-0.02716156081164378*x1^3*x2-0.02708885812522822*x1^3*x3+0.2240094021882353*x1^2*x2^2+0.4399640327471952*x1^2*x2*x3-0.4691321899483339*x1^2*x3^2+0.04251686032081572*x1*x2^3+0.009187018405654742*x1*x2^2*x3-0.09220713868055416*x1*x2*x3^2-0.06760769468185925*x1*x3^3+0.1488568286343931*x2^4+0.02325223946328157*x2^3*x3+0.3816787511347403*x2^2*x3^2-0.04257663299873744*x2*x3^3+0.467569625242744*x3^4+0.03201239138642915*x1^3-0.01887157059636539*x1^2*x2-0.02573972940739003*x1^2*x3+0.03162825132940131*x1*x2^2+0.04361577201095797*x1*x2*x3-0.1037075490574651*x1*x3^2-0.003366067501592693*x2^3-0.01608336337051472*x2^2*x3+0.01202496046162058*x2*x3^2+0.0233276368120514*x3^3+0.9707911104056866*x1^2-0.01988459016624386*x1*x2-0.1019143611403437*x1*x3+0.3477003513384749*x2^2+0.1331396702460586*x2*x3+0.5228630711587768*x3^2+0.001316609278053213*x1+3.001695459008127e-05*x2-4.3784027128929e-05*x3+9.260142686821981;
C0 = 18.453381984491568; 
%% New CBF
B_2 = - 155.1679086098446305186371318996*x1^4 + 4.1252996118450422358137075207196*x1^3*x2 + 2.9124602544426410055677933996776*x1^3*x3 + 0.85952799101245902502199669470428*x1^3 + 105.90631553740665538043685955927*x1^2*x2^2 - 5.1585575458326564657340895792004*x1^2*x2*x3 + 0.125572929828481949510177173579*x1^2*x2 + 199.86697922935266547028732020408*x1^2*x3^2 - 0.86091909077676664896472402688232*x1^2*x3 - 0.52428040854687074645568145569996*x1^2 - 4.4496746331224690251815445662942*x1*x2^3 - 3.9648082648753373291583557147533*x1*x2^2*x3 - 0.6958962173263882888818443461787*x1*x2^2 + 0.96383174402158444671329107222846*x1*x2*x3^2 + 3.6200519139518085864892782410607*x1*x2*x3 + 0.28199208304735490226988758877269*x1*x2 + 1.6988023895713015853914384933887*x1*x3^3 + 3.4144460497930224640583674045047*x1*x3^2 - 0.0302249987980013415378444108228*x1*x3 - 0.01201525020178525679503955814198*x1 - 32.18598255732464963330130558461*x2^4 + 2.1632280599002062793090317427414*x2^3*x3 + 1.2304235413850548308545285181026*x2^3 - 42.94793927574850300743491970934*x2^2*x3^2 - 0.015348271395937286565303026009133*x2^2*x3 - 0.18808238111091313271572289522737*x2^2 - 3.1860582991845460831825675995788*x2*x3^3 - 2.0152199674301458642844409041572*x2*x3^2 - 0.28033030318193924435021813224012*x2*x3 - 0.0012680724745507429649521435877091*x2 - 81.672746819698787135166639927775*x3^4 + 0.20187490393271115274309579490364*x3^3 - 0.268294278726131762979889572307*x3^2 - 0.0090262717733285841026358298222476*x3 + 628.29526604568468428624328225851;
%% Plot
figure(9999);clf;hold on;
xlim([-dom dom]); ylim([-dom dom]); zlim([-dom dom]); view(-30,20);
dom = 20; domain = [-dom dom -dom dom -dom dom];
ph1= patch(pcontour3(C1,0,domain,'c')); set(ph1, 'FaceColor', 'none', 'EdgeColor', 'k' );
ph2= patch(pcontour3(C2,0,domain,'c')); set(ph2, 'FaceColor', 'none', 'EdgeColor', 'k' );
ph3= patch(pcontour3(C3,0,domain,'c')); set(ph3, 'FaceColor', 'none', 'EdgeColor', 'k' );
ph4= patch(pcontour3(C4,0,domain,'c')); set(ph4, 'FaceColor', 'none', 'EdgeColor', 'k' );
phV0= patch(pcontour3(V0,double(C0),domain,'G')); 
set(phV0,'EdgeAlpha',0.6, 'FaceColor', 'none', 'EdgeColor', 'g' );
phVC= patch(pcontour3(V0,double(C),domain,'G')); 
set(phVC,'EdgeAlpha',0.5, 'FaceColor', 'none', 'EdgeColor', 'M' );
%%
inH = patch(pcontour3(B_1,0,domain,'c'));
set(inH, 'EdgeAlpha',0.3,'FaceColor', 'none', 'EdgeColor', 'c','LineStyle','-','LineWidth',1.5 ); hold on;
%%
inV = patch(pcontour3(V,double(C0),domain,'r'));
set(inV, 'EdgeAlpha',1,'FaceColor', 'none', 'EdgeColor', 'r','LineStyle','-','LineWidth',1 ); hold on;
%%
inB = patch(pcontour3(B_2,0,domain,'g'));
set(inB, 'EdgeAlpha',1,'FaceColor', 'none', 'EdgeColor', 'g','LineStyle','-','LineWidth',1.5 ); hold on;


%%
% legend([ph4,ph1,h1],{'$h(x)\geq 0$','$V(x)\leq c_0$','$Vector Field$'}, 'Interpreter','latex','location','northwest');
legend([ph4,ph1],{'$h(x)\geq 0$','$V(x)\leq c_0$'}, 'Interpreter','latex','location','northwest');


title('');
xlabel('$x_1$','Interpreter','latex','Fontsize',24);
ylabel('$x_2$','Interpreter','latex','Fontsize',24);
zlabel('$x_3$','Interpreter','latex','Fontsize',24);
set(gca,'xtick',[-20,-10,0,10,20]);
set(gca,'ytick',[-20,-10,0,10,20]);
set(gca,'ztick',[-20,-10,0,10,20]);
set(gca,'LooseInset',get(gca,'TightInset'))