clear;tic;
pvar x1 x2 x3 u htol epsi;
x = [x1;x2;x3];
figure_id = 213;
load LF_Opt
%% 26
% V = 0.7754493780412083*x1^4+0.01538143725956307*x1^3*x2-0.01193322783720551*x1^3*x3+0.1406438731320798*x1^2*x2^2+0.1014046006280144*x1^2*x2*x3-0.9550442999604613*x1^2*x3^2+0.0240910069628206*x1*x2^3+0.004303355017772573*x1*x2^2*x3-0.1074291288708021*x1*x2*x3^2-0.04030442091571095*x1*x3^3+0.1044002123665394*x2^4+0.02342017217092511*x2^3*x3+0.3123479952953659*x2^2*x3^2+0.07980855015340288*x2*x3^3+0.6527375651414437*x3^4+0.02009548179139661*x1^3-0.01537810103459676*x1^2*x2-0.01662614893620694*x1^2*x3+0.01738550368743247*x1*x2^2+0.01074722111660453*x1*x2*x3-0.08818121834264446*x1*x3^2+0.001698655876194973*x2^3-0.000237077928820955*x2^2*x3+0.003223829411089607*x2*x3^2+0.009841041529572332*x3^3+0.2675033622283891*x1^2-0.01636121664970925*x1*x2-0.05656214583866465*x1*x3+0.07861645436743456*x2^2+0.0765934355839933*x2*x3+0.1717958491629204*x3^2+0.0004207558255661851*x1-1.769975122612027e-06*x2-4.65115204606246e-05*x3+6.52177325710281;
% C0 = 14.961569805334348;
%%
% V = 1.846093042911731e-06*x1^4-4.627288219319764e-09*x1^3*x2-2.42831407319417e-07*x1^3*x3+8.716363489259197e-06*x1^2*x2^2+6.064698391362617e-10*x1^2*x2*x3-1.846909465556521e-06*x1^2*x3^2+1.877088437176688e-07*x1*x2^3+1.468077863562659e-05*x1*x2^2*x3-4.116811204377438e-08*x1*x2*x3^2+1.276615751787972e-06*x1*x3^3+1.616945733553308e-05*x2^4+3.413965418566134e-09*x2^3*x3+1.835586748554252e-05*x2^2*x3^2+1.291048611359306e-08*x2*x3^3+6.499362386835279e-06*x3^4+3.294350724350089e-06*x1^3-4.021281472015795e-07*x1^2*x2-4.162530071145731e-07*x1^2*x3+9.735668698842179e-05*x1*x2^2-5.715886885555366e-08*x1*x2*x3+6.876817448038762e-06*x1*x3^2+5.275301446999913e-07*x2^3-8.084262415438414e-05*x2^2*x3-2.724325130896884e-06*x2*x3^2-2.562705935605319e-06*x3^3+8.128849278956559e-05*x1^2-2.171786426961404e-05*x1*x2-9.338622412175618e-06*x1*x3+0.0139426387591258*x2^2+1.943150232617463e-06*x2*x3+6.989495370438081e-05*x3^2-1.586690957428437e-07*x1-9.723090893204663e-07*x2-3.415934200129217e-07*x3+0.335357026001617;
% C0 = 0.335645027925382;
%%
% V = 2.479271922855055*x1^4+0.003209100451638928*x1^3*x2+0.009599771005725417*x1^3*x3+3.476234283444618*x1^2*x2^2-0.00481986576927699*x1^2*x2*x3+4.518273854539418*x1^2*x3^2-0.004272052190729689*x1*x2^3+0.02382666224934429*x1*x2^2*x3+0.008675907442924921*x1*x2*x3^2+0.01646865492822963*x1*x3^3+4.500165982255748*x2^4-0.02822486468503896*x2^3*x3+5.7812231994986*x2^2*x3^2-0.0279532150254435*x2*x3^3+3.649133530667497*x3^4+0.08617265896163105*x1^3-0.07023448751073896*x1^2*x2+0.006728166625465741*x1^2*x3+0.2382758575214712*x1*x2^2+0.0269624573406161*x1*x2*x3+0.1451485904172275*x1*x3^2-0.08277181560573749*x2^3+0.04613652235063141*x2^2*x3-0.04869797684934517*x2*x3^2+0.02617826176292243*x3^3+7.377565467107495*x1^2+0.107657057674288*x1*x2+0.06116890841665774*x1*x3+11.21970591295234*x2^2-0.1651227645407483*x2*x3+8.489179510021165*x3^2+0.0003511313466528669*x1-4.6934472971652e-05*x2+8.247038302719945e-05*x3+128.510846133201;
% C0 = 1.0e+02*1.759414119872870;
%%
% V = 0.1135775824020298*x1^4-2.220808712302209e-05*x1^3*x2+7.762362940710624e-05*x1^3*x3+0.1898596809111971*x1^2*x2^2+4.511912044098073e-06*x1^2*x2*x3+0.1836298740895287*x1^2*x3^2-3.870739683864878e-05*x1*x2^3+0.0005286496278839283*x1*x2^2*x3-3.080075682589171e-05*x1*x2*x3^2+0.0001792360505783084*x1*x3^3+0.2091460261090588*x2^4-1.390196012167545e-05*x2^3*x3+0.2377954152074183*x2^2*x3^2-9.599400593916341e-06*x2*x3^3+0.1476926330486525*x3^4-0.0002297797914341284*x1^3-3.615200129485743e-07*x1^2*x2+0.0002119762227304953*x1^2*x3+0.000655887490119088*x1*x2^2-1.479727867228187e-07*x1*x2*x3-0.0001587792446848378*x1*x3^2-6.794389047505371e-07*x2^3-0.0001054907613712006*x2^2*x3+8.098971154261359e-07*x2*x3^2-2.238963238244891e-05*x3^3+0.2768835193163477*x1^2-0.0001380899273867321*x1*x2+8.815038817742137e-05*x1*x3+0.48793513178905*x2^2-6.557673205071866e-06*x2*x3+0.3411347984726278*x3^2-3.282956229698805e-06*x1-1.227359016850969e-07*x2+5.787712989884529e-07*x3+104.94463764569;
% C0 = 1.0e+02*1.069044441022970;
%%
% k_u = 4; k_h = 4; L_us = 4; L_au = 2; gamma = 0;
%%
k_u = 4; k_h = 4; L_us = 4; L_au = 4; gamma = 0;

%%

f = [-0.16211179709695037165964324641892*x1^4+0.49031898059485488031675707268867*x1^3-0.80741059860165544525334054266171*x1^2-0.67918469453797989758096302163419*x1-0.000031796033448678815965058458425929*x2^4+0.00049811603934539429219124917480599*x2^3-0.017884574789259536503616132563366*x2^2+0.059003602596920091960530641017613*x2+0.14736298331076760903535216584714*x3^4-0.22234685217253638556123007674614*x3^3+0.14008297734444075111071015271591*x3^2+0.34076230832989312657943514750514*x3-1.4865840251194628709408125437986
    -x2*x1^3-x2
    1.876321954439673866943394386908*x1^4-1.8803947547684580765547934788628*x1^3-x1^2*x3-0.3521313244010295662178577913437*x1^2-0.58570314276461321600919518459705*x1+0.0008606977977094753011130801034767*x2^4-0.0047246616639717428295930368165045*x2^3+0.0073970075005580443808228530144788*x2^2-0.39277632595769917944750204696902*x2-0.63399852647351906398398568853736*x3^4-2.3526877462367330462456038731034*x3^3-0.18912599086086179234200699283974*x3^2-1.2624646738177363047839207865763*x3+1.2361363889678920191528277428006
    ];
gg = [1;1;1];
C1 = (x1+4)^2+(x2-6)^2+(x3+2)^2-4;
C2 = (x1+3)^2+(x2+4)^2+(x3+4)^2-4;
C3 = (x1-4)^2+(x2-0)^2+(x3-0)^2-5;
C4 = (x1+4)^2+(x2-2)^2+(x3-4)^2-5;
% C = [C1;C2;C3;C4];
C = [C2;C3;C4];
trace_Q1 = 1; trace_Q = 0; mm = 0; kk = 1; i = 0;
%%
dom = 10; domain = [-dom dom -dom dom -dom dom];
for i = 1:length(B)
    figure(figure_id+100+i);clf;hold on;
    V = B(i,1);
    C0 = B(i,2);
    sol_B = C0 - V; solh = sol_B;
    % ph1= patch(pcontour3(C1,0,domain,'c')); set(ph1, 'FaceColor', 'none', 'EdgeColor', 'k' );
    ph2= patch(pcontour3(C2,0,domain,'c')); set(ph2, 'FaceColor', 'none', 'EdgeColor', 'k' );
    ph3= patch(pcontour3(C3,0,domain,'c')); set(ph3, 'FaceColor', 'none', 'EdgeColor', 'k' );
    ph4= patch(pcontour3(C4,0,domain,'c')); set(ph4, 'FaceColor', 'none', 'EdgeColor', 'k' );
    phV0= patch(pcontour3(V,double(C0),domain,'G')); set(phV0,'EdgeAlpha',1, 'FaceColor', 'none', 'EdgeColor', 'g' );
    xlim([-dom dom]); ylim([-dom dom]); zlim([-dom dom]); view(-30,20);
    % axis equal
    %%
    % B_controller_1 = - 273.39650242684382419611210934818*x1^4 + 3.2589263027938537575778354948852*x1^3*x2 + 3.3562511580000289335146135272225*x1^3*x3 - 0.015310159136399738993850050405854*x1^3 + 49.560606565764210529323463561013*x1^2*x2^2 - 5.6863118500645093433831789297983*x1^2*x2*x3 - 1.839760885155375058630511375668*x1^2*x2 + 492.75971320250397411655285395682*x1^2*x3^2 - 1.5992531329666697104130435036495*x1^2*x3 - 0.06476811099359396084462758835798*x1^2 - 4.4810995274363758511526611982845*x1*x2^3 - 4.1790204996910276236121717374772*x1*x2^2*x3 + 1.897106711113640820087766769575*x1*x2^2 + 1.9410588550273071284379966527922*x1*x2*x3^2 + 4.6231191532671704891299668815918*x1*x2*x3 + 0.178092708725241050116139263082*x1*x2 + 1.5480254619169324659111453001969*x1*x3^3 + 2.7257282965782598793680335802492*x1*x3^2 + 0.12158874575605656265242515701175*x1*x3 - 0.000081013903294964385772697346155269*x1 - 16.986346934193537805413143360056*x2^4 + 2.7918880650780653063236513844458*x2^3*x3 + 1.7519110948437255359522168873809*x2^3 - 16.66612225822484916193388926331*x2^2*x3^2 + 1.182358264011557746897551623988*x2^2*x3 - 0.87342702549842854420347748600761*x2^2 - 3.6388353511441993148878282227088*x2*x3^3 - 0.58096981620094623188776949973544*x2*x3^2 - 0.69804408467847633978919930086704*x2*x3 + 0.000012981585341486740300303084905131*x2 - 241.85695481156326991367677692324*x3^4 - 0.27175859700355692316620093151869*x3^3 - 0.16597403855979686593258293214603*x3^2 + 0.000041307146010535933280515691334855*x3 + 694.5013932663647437948384322226;
    % phB= patch(pcontour3(B_controller_1,0,domain,'B')); set(phB,'EdgeAlpha',0.4,'FaceColor', 'none', 'EdgeColor', 'b','LineStyle','-','LineWidth',1);
    axis(domain); TRACE = []; Barrier = []; Control = [];
    %%
    % for j = 1:56
    while 1
        i = i+1
        record_Q = trace_Q
        %%
        [SOLu1,SOLu2,SOLu3,SOL1,SOL2,kk] = sos_function_1_3D(f,k_u,L_au,solh,V,gamma,gg);
        if kk == 0
            break
        end
        Control = [Control; [SOLu1 SOLu2 SOLu3]];
        %%
        [solh,trace_Q,kk] = sos_function_2_3D(i,f,k_h,SOLu1,SOLu2,SOLu3,SOL1,SOL2,gamma,V,C,dom,gg,L_us,figure_id);
        if kk == 0
            break
        end
        TRACE = [TRACE; double(trace_Q)];
        Barrier = [Barrier; solh];
    end
end
toc