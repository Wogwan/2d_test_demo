clear;tic;
pvar x1 x2 x3 u htol epsi;
format long;
x = [x1;x2;x3];
dom = 10; domain = [-dom dom -dom dom -dom dom];
figure_id = 311;
%%
C1 = (x1-3)^2+(x2-0)^2+(x3-0)^2-2;
C2 = (x1+4)^2+(x2+4)^2+(x3-4)^2-4;
C3 = (x1-0)^2+(x2-4)^2+(x3+0)^2-4;
C4 = (x1-4)^2+(x2-0)^2+(x3+4)^2-6;
C = [C2;C3;C4];
V00 = 1*x1^4+1*x2^4+1*x3^4+1*x1^2*x2^2+1*x3^2*x2^2+1*x1^2*x3^2;
CC0 = 16.00000001852458;
%%
Compute = {};
f = [-0.16211179709864792508611230914539*x1^4+0.46967680241313530098423711933719*x1^3-0.80741059859268821864900068453951*x1^2-0.52420770456533548609101558213297*x1-0.000031796033448678815965058458425929*x2^4+0.00049811603934539429219124917480599*x2^3-0.017884574789259536503616132563366*x2^2+0.059003602596920091960530641017613*x2+0.14736298331076760903535216584714*x3^4-0.22234685217253638556123007674614*x3^3+0.14008297734444075111071015271591*x3^2+0.34076230832989312657943514750514*x3-1.4865840251312778030530597727999
    -x2*x1^3-x2
    1.876321954439673866943394386908*x1^4-1.8803947547684580765547934788628*x1^3-x1^2*x3-0.3521313244010295662178577913437*x1^2-0.58570314276461321600919518459705*x1+0.0008606977977094753011130801034767*x2^4-0.0047246616639717428295930368165045*x2^3+0.0073970075005580443808228530144788*x2^2-0.39277632595769917944750204696902*x2-6.3527586089398613289347395038931*x3^4+9.1026400980830752818206974552595*x3^3+5.2275118144867558367394622109714*x3^2-10.044858323825100132609122738359*x3+0.61281374087452245014162599545671
    ];
gg = [1;1;1];
%%
trace_Q1 = 1; trace_Q = 0;
mm = 0; kk = 1;
%%
% k_u = 6; k_h = 6; L_us = 6; L_au = 2; gamma = 0;
k_u = 4; k_h = 6; L_us = 6; L_au = 6; gamma = 0;
%%
figure(figure_id);clf;hold on;xlim([-dom dom]); ylim([-dom dom]); zlim([-dom dom]);
%%
V = 0.0000060628608055602979182629672094684*x3 - 0.0000067675703200166485644742077332214*x2 - 0.00005454759738305132901314137283677*x1 + 0.26661325653767353749401536333608*x1^2*x2^2 + 0.41069949933722138535330259401235*x1^2*x3^2 + 0.41595368411811250997089928205241*x2^2*x3^2 + 0.020274301250950803321426718639486*x1*x2 + 0.0031001532484856548187168723273999*x1*x3 - 0.0015366303962801076705285696633041*x2*x3 + 0.0024731325980859712211634704459584*x1*x2^2 + 0.010342392463781546751988571486436*x1^2*x2 + 0.01306171556753603704703614596383*x1*x2^3 - 0.0034585829004679393382237773124643*x1*x3^2 + 0.0025855634231008737047852186208274*x1^2*x3 + 0.012415869026440980865677587985374*x1^3*x2 - 0.0045576548519059541589304451747466*x1*x3^3 + 0.0083397396187321840704820274936537*x2*x3^2 - 0.0036790709798816012034150535470189*x1^3*x3 - 0.0024786613870084270999649689315447*x2^2*x3 - 0.0036918673028364106143695000383786*x2*x3^3 - 0.0039046750495246281345562699982565*x2^3*x3 + 0.48497312827121141776132162704016*x1^2 + 0.00013565635903478416579570620115192*x1^3 + 0.47945253453319691683276460025809*x2^2 + 0.45349975896539518327443829548429*x1^4 + 0.0062382651801217263443088967278527*x2^3 + 0.20195861033160802944230738376064*x3^2 + 0.45169058126362765515082742240338*x2^4 - 0.00087478174338584131341373106849346*x3^3 + 0.19936507997176705631048321265553*x3^4 - 0.00080570054924889475227167690007946*x1*x2*x3^2 - 0.01669116265096037485249347298577*x1*x2^2*x3 - 0.015666447068864820107991775444134*x1^2*x2*x3 - 0.0017388589541671103672754172819737*x1*x2*x3 + 8.8208575573753691401179821696132;
C0 = 18.01447611448137;
%%
sol_B = C0 - V; solh = sol_B;
TRACE = []; Barrier = []; Control = []; iter = 0;
%%
figure_id = figure_id+1;
figure(figure_id);clf;
B1 = 0.0000075554744730387974550509487536853*x1 - 0.000062452509667594563848649902304544*x2 - 0.0000094536644338568998790399769416304*x3 + 5.7177725801762333546207628387492*x1^2*x2^2 + 20.1928090863874061255955894012*x1^2*x3^2 + 3.8614992476604590443400866206503*x2^2*x3^2 + 0.018212846982981430177250814494982*x1*x2 - 0.01145787770290857161825659460419*x1*x3 - 0.018547410355871145337669503305733*x2*x3 + 0.098315478397926744924539832481969*x1*x2^2 + 0.10136587655864369439395744620924*x1^2*x2 - 0.19273844399410694494534368459426*x1*x2^3 - 0.015423448637079287953932649202216*x1*x3^2 - 0.011138214950815818887752683963299*x1^2*x3 + 0.010802697013372681428267085834705*x1^3*x2 + 0.24968149198303257740860772173619*x1*x3^3 + 0.063302826399716224936575770243508*x2*x3^2 + 0.33754062029491255225721602073463*x1^3*x3 - 0.099704944432423933675657679032156*x2^2*x3 - 0.10229806062567169122612398268757*x2*x3^3 + 0.18371604367301122562317061692738*x2^3*x3 - 0.017174943735070363759476208542765*x1^2 - 0.027719467512489208427250986233048*x1^3 - 0.10600894771855209897104543870228*x2^2 - 13.04428969735702992238657316193*x1^4 - 0.09127618296980347101232666773285*x2^3 - 0.019040390416220069613739696023913*x3^2 - 4.9251259633765824830220481089782*x2^4 + 0.055473328295352203332058138585126*x3^3 - 12.258504648699144468082522507757*x3^4 + 0.050015660612267094642380271807269*x1*x2*x3^2 - 0.43669399669388481166620863405115*x1*x2^2*x3 + 0.047847391607838622717974175202471*x1^2*x2*x3 - 0.076092135580705183572902683408756*x1*x2*x3 + 63.474090980072013223889371147379;
inV = patch(pcontour3(B1,0,domain,'b'));
set(inV,'EdgeAlpha',0.1,'FaceColor', 'none', 'EdgeColor', 'r','LineStyle','-','LineWidth',0.6); hold on;
ph2= patch(pcontour3(C2,0,domain,'c')); set(ph2, 'FaceColor', 'none', 'EdgeColor', 'k' );
ph3= patch(pcontour3(C3,0,domain,'c')); set(ph3, 'FaceColor', 'none', 'EdgeColor', 'k' );
ph4= patch(pcontour3(C4,0,domain,'c')); set(ph4, 'FaceColor', 'none', 'EdgeColor', 'k' );
phV0= patch(pcontour3(V,double(C0),domain,'G')); set(phV0,'EdgeAlpha',1, 'FaceColor', 'none', 'EdgeColor', 'g','LineStyle','-','LineWidth',1);
%%
iter = iter+1
record_Q = trace_Q
%%
[SOLu1,SOLu2,SOLu3,SOL1,SOL2,kk] = sos_function_1_3D(f,k_u,L_au,solh,V,gamma,gg);
Control = [Control; [SOLu1 SOLu2 SOLu3]];
%%
[solh,trace_Q,kk] = sos_function_2_3D(iter,f,k_h,SOLu1,SOLu2,SOLu3,SOL1,SOL2,gamma,V,C,dom,gg,L_us,figure_id);
TRACE = [TRACE; double(trace_Q)];
Barrier = [Barrier; solh];
view(-121,-10);
%%
fprintf('Optimal B(x) is \n%s \n\n',char(vpa(p2s(Barrier(end)))));
toc