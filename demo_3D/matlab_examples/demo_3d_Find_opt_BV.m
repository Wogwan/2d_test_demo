clear;tic;
pvar x1 x2 x3 u htol epsi;
format long;
x = [x1;x2;x3];
dom = 10; domain = [-dom dom -dom dom -dom dom];
figure_id = 311;
%%
C1 = (x1-3)^2+(x2-0)^2+(x3-0)^2-2;
C2 = (x1+4)^2+(x2+4)^2+(x3-4)^2-4;
C3 = (x1-0)^2+(x2-4)^2+(x3+0)^2-4;
C4 = (x1-4)^2+(x2-0)^2+(x3+4)^2-6;
C = [C2;C3;C4];
%%
Compute = {};
f = [-0.16211179709864792508611230914539*x1^4+0.46967680241313530098423711933719*x1^3-0.80741059859268821864900068453951*x1^2-0.52420770456533548609101558213297*x1-0.000031796033448678815965058458425929*x2^4+0.00049811603934539429219124917480599*x2^3-0.017884574789259536503616132563366*x2^2+0.059003602596920091960530641017613*x2+0.14736298331076760903535216584714*x3^4-0.22234685217253638556123007674614*x3^3+0.14008297734444075111071015271591*x3^2+0.34076230832989312657943514750514*x3-1.4865840251312778030530597727999
    -x2*x1^3-x2
    1.876321954439673866943394386908*x1^4-1.8803947547684580765547934788628*x1^3-x1^2*x3-0.3521313244010295662178577913437*x1^2-0.58570314276461321600919518459705*x1+0.0008606977977094753011130801034767*x2^4-0.0047246616639717428295930368165045*x2^3+0.0073970075005580443808228530144788*x2^2-0.39277632595769917944750204696902*x2-6.3527586089398613289347395038931*x3^4+9.1026400980830752818206974552595*x3^3+5.2275118144867558367394622109714*x3^2-10.044858323825100132609122738359*x3+0.61281374087452245014162599545671
    ];
gg = [1;1;1];
%%
trace_Q1 = 1; trace_Q = 0;
mm = 0; kk = 1;
%%
% k_u = 6; k_h = 6; L_us = 6; L_au = 2; gamma = 0;
k_u = 4; k_h = 4; L_us = 4; L_au = 2; gamma = 0;
%%
figure(figure_id);clf;hold on;xlim([-dom dom]); ylim([-dom dom]); zlim([-dom dom]);
%%
V = 0.15262216021712840530177857090166*x1 + 0.098262351849115456281502645197179*x2 + 0.12547086987215338993451041460503*x3 + 0.33475379324085863252946637658169*x1^2*x2^2 - 0.33201166533136744485332769727393*x1^2*x3^2 - 1.0336484598631696663062484731199*x2^2*x3^2 + 0.072895564743315710565241261065239*x1*x2 + 0.079779852202941523020562897272612*x1*x3 - 0.028505240380140510481066229431235*x2*x3 + 0.10601990130512847776422802326124*x1*x2^2 - 0.0018975139402669122679762070404763*x1^2*x2 + 0.081849877163025261395112863738177*x1*x2^3 - 0.23231466771492709222357575526985*x1*x3^2 - 0.02811487841558210631909275889484*x1^2*x3 + 0.057337316563754195386515277732542*x1^3*x2 - 0.022553475511912949441617470824895*x1*x3^3 + 0.0024212740083352996336985007985731*x2*x3^2 + 0.029835719308269368493791162677553*x1^3*x3 - 0.075585016094567705757789610743203*x2^2*x3 + 0.057935730725925567441425556580725*x2*x3^3 - 0.047462291878356904772928714919544*x2^3*x3 + 0.095623523343395161466773402025865*x1^2 + 0.038340716855404646801197543481976*x1^3 + 0.10779239865203520121195168712802*x2^2 + 0.11242606670229465803956259151164*x1^4 + 0.022620214673315798548092203645865*x2^3 + 0.049163527809058013562371058924327*x3^2 + 0.45955749986413146901398363297631*x2^4 - 0.0047924211852991144278135493550508*x3^3 + 0.74908482625988148662088406126713*x3^4 - 0.088614880647068336450011827309936*x1*x2*x3^2 + 0.056022378314697314494186031197387*x1*x2^2*x3 - 0.010645205789755573036470259751241*x1^2*x2*x3 + 0.021345023534847486906818048169043*x1*x2*x3 + 20.808884521275363255199408740737;
C0 = 26.55026620001978;
%%
sol_B = C0 - V; solh = sol_B;
TRACE = []; Barrier = []; Control = []; iter = 0;
% while 1
for i = 1:7
    %%
    figure_id = figure_id+1;
    figure(figure_id);clf;
    B1 = 17365.25447007778348051942884922*x1^2*x3^2 - 772.97762945060708261735271662474*x2 - 950.78283091693867845606291666627*x3 - 11916.79233659101919329259544611*x1^2*x2^2 - 1127.0541170537956077168928459287*x1 + 48290.448345255470485426485538483*x2^2*x3^2 - 291.10539025282906777647440321743*x1*x2 - 702.48498440172909340617479756474*x1*x3 - 368.11648201315580308801145292819*x2*x3 - 2269.024202167850035039009526372*x1*x2^2 + 1023.782165231908606983779463917*x1^2*x2 - 3071.4743898837432425352744758129*x1*x2^3 + 4900.2261525390222232090309262276*x1*x3^2 + 728.82409038436787795944837853312*x1^2*x3 - 1377.9554799214677132113138213754*x1^3*x2 + 2429.2209307250018355262000113726*x1*x3^3 - 1392.8009350646709663124056532979*x2*x3^2 - 87.616144222155440957067185081542*x1^3*x3 + 1195.3361341340955732448492199183*x2^2*x3 - 1357.9066509522849628410767763853*x2*x3^3 + 1084.0180135997206889442168176174*x2^3*x3 - 237.52272231029201066121459007263*x1^2 - 1207.707956565701806539436802268*x1^3 + 246.64502890328370199313212651759*x2^2 - 3796.7118930366918903018813580275*x1^4 + 1338.475598779357369494391605258*x2^3 - 445.46831620041626820238889195025*x3^2 - 19110.490099057598854415118694305*x2^4 - 949.69843786950161756976740434766*x3^3 - 32343.761161970262037357315421104*x3^4 + 3803.5504555278575935517437756062*x1*x2*x3^2 - 1999.6906956040857039624825119972*x1*x2^2*x3 + 211.10160515196014330285834148526*x1^2*x2*x3 + 377.08242543314162276146817021072*x1*x2*x3 + 157361.34696154913399368524551392;
    inV = patch(pcontour3(B1,0,domain,'b'));
    set(inV,'EdgeAlpha',0.1,'FaceColor', 'none', 'EdgeColor', 'r','LineStyle','-','LineWidth',0.6); hold on;
    ph2= patch(pcontour3(C2,0,domain,'c')); set(ph2, 'FaceColor', 'none', 'EdgeColor', 'k' );
    ph3= patch(pcontour3(C3,0,domain,'c')); set(ph3, 'FaceColor', 'none', 'EdgeColor', 'k' );
    ph4= patch(pcontour3(C4,0,domain,'c')); set(ph4, 'FaceColor', 'none', 'EdgeColor', 'k' );
    phV0= patch(pcontour3(V,double(C0),domain,'G')); set(phV0,'EdgeAlpha',1, 'FaceColor', 'none', 'EdgeColor', 'g','LineStyle','-','LineWidth',1);
    %%
    iter = iter+1
    record_Q = trace_Q
    %%
    [SOLu1,SOLu2,SOLu3,SOL1,SOL2,kk] = sos_function_1_3D(f,k_u,L_au,solh,V,gamma,gg);
    Control = [Control; [SOLu1 SOLu2 SOLu3]];
    %%
    [solh,trace_Q,kk] = sos_function_2_3D(iter,f,k_h,SOLu1,SOLu2,SOLu3,SOL1,SOL2,gamma,V,C,dom,gg,L_us,figure_id);
    TRACE = [TRACE; double(trace_Q)];
    Barrier = [Barrier; solh];
    view(-121,-10);
end
%%
fprintf('Optimal B(x) is \n%s \n\n',char(vpa(p2s(Barrier(end)))));
toc