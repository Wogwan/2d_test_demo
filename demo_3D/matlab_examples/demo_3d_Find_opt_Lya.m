clear;
pvar x1 x2 x3 u1 u2 u3 htol epsi;
format long
x = [x1;x2;x3];
%%
f = [-0.16211179709864792508611230914539*x1^4+0.46967680241313530098423711933719*x1^3-0.80741059859268821864900068453951*x1^2-0.52420770456533548609101558213297*x1-0.000031796033448678815965058458425929*x2^4+0.00049811603934539429219124917480599*x2^3-0.017884574789259536503616132563366*x2^2+0.059003602596920091960530641017613*x2+0.14736298331076760903535216584714*x3^4-0.22234685217253638556123007674614*x3^3+0.14008297734444075111071015271591*x3^2+0.34076230832989312657943514750514*x3-1.4865840251312778030530597727999
    -x2*x1^3-x2
    1.876321954439673866943394386908*x1^4-1.8803947547684580765547934788628*x1^3-x1^2*x3-0.3521313244010295662178577913437*x1^2-0.58570314276461321600919518459705*x1+0.0008606977977094753011130801034767*x2^4-0.0047246616639717428295930368165045*x2^3+0.0073970075005580443808228530144788*x2^2-0.39277632595769917944750204696902*x2-6.3527586089398613289347395038931*x3^4+9.1026400980830752818206974552595*x3^3+5.2275118144867558367394622109714*x3^2-10.044858323825100132609122738359*x3+0.61281374087452245014162599545671
    ];
gg = [1;1;1];
sys = [f(1)+gg(1)*u1; f(2)+gg(2)*u2; f(3)+gg(3)*u3];
%%
dom = 10; domain = [-dom dom -dom dom -dom dom];
C1 = (x1-3)^2+(x2-0)^2+(x3-0)^2-2;
C2 = (x1+4)^2+(x2+4)^2+(x3-4)^2-4;
C3 = (x1-0)^2+(x2-4)^2+(x3+0)^2-4;
C4 = (x1-4)^2+(x2-0)^2+(x3+4)^2-6;
%%
C = [C2;C3;C4];
V0 = x1^4+x1^3*x2+x1^2*x2^2+x1*x2^3+x2^4+x1^3*x3+x1^2*x2*x3+x1*x2^2*x3+x2^3*x3+x1^2*x3^2+x1*x2*x3^2+x2^2*x3^2+x1*x3^3+x2*x3^3+x3^4+x1^3+x1^2*x2+x1*x2^2+x2^3+x1^2*x3+x1*x2*x3+x2^2*x3+x1*x3^2+x2*x3^2+x3^3+x3^2+x1^2+x1*x2+x2^2+x1*x3+x2*x3+x1+x2+x3+1; 
CC0 = 24.92234264283737;
%%
figure_id = 211;
A_V = [];
A_C0 = [];
%% Start to compute the control barrier function
u1 = 20.265361900776419190606247866526*x1^2*x2^2 - 66.319771645717906949357711710036*x2 - 21.765967559081797588760309736244*x3 - 56.728523092945124517427757382393*x1 - 18.736600328103815371605378459208*x1^2*x3^2 + 8.7849772372129688591257945518009*x2^2*x3^2 + 72.015663549638091467386402655393*x1*x2 + 18.19316760261431653589170309715*x1*x3 - 12.201172507117016508004780916963*x2*x3 - 66.75482664575835656251001637429*x1*x2^2 + 49.770167059105183682277129264548*x1^2*x2 + 32.438622711491120753635186702013*x1*x2^3 - 456.72635373661142921264399774373*x1*x3^2 + 31.818742615621765423838951392099*x1^2*x3 - 2.3417241019751435793239124905085*x1^3*x2 + 26.158138361602027543995063751936*x1*x3^3 + 330.57857259363760249470942653716*x2*x3^2 - 5.1442307548976229369941393088084*x1^3*x3 + 127.00731674570961615700070979074*x2^2*x3 - 1.6398043427302790853161695849849*x2*x3^3 + 7.5035725440827265586563044053037*x2^3*x3 + 24.127704573411570265761838527396*x1^2 - 60.535195125948746408539591357112*x1^3 - 191.09936245895599427058186847717*x2^2 + 9.9088718627579357445256391656585*x1^4 - 178.46415401613759854626550804824*x2^3 - 110.31791473746216070139780640602*x3^2 - 2.2168966929157121192872637038818*x2^4 - 95.907935847117130379047011956573*x3^3 - 11.329725985673210431059487746097*x3^4 - 16.49930536248466594884121150244*x1*x2*x3^2 - 18.018511179832227497854546527378*x1*x2^2*x3 + 0.46232069902881145484485614360892*x1^2*x2*x3 - 111.75070795211289009785105008632*x1*x2*x3 - 42.419230283975863926571037154645;
u2 = 10.592191045445627395338306087069*x1 + 2.6085908068791265890240538283251*x2 + 60.478228076007368940736341755837*x3 - 10.886006531339857517082236881834*x1^2*x2^2 - 0.68139403473988002790662221741513*x1^2*x3^2 + 17.753817229290344670289414352737*x2^2*x3^2 + 82.417057973591539621338597498834*x1*x2 + 11.613993105985597864560077141505*x1*x3 - 46.47881077172050368062627967447*x2*x3 + 53.057900288087928686309169279411*x1*x2^2 + 33.112127785713951766410900745541*x1^2*x2 + 1.1422861543628393121707631507888*x1*x2^3 + 38.482403912164393489092617528513*x1*x3^2 + 25.3648862279515761031234433176*x1^2*x3 - 1.2895526494986153664967787335627*x1^3*x2 + 38.089209561352042499038361711428*x1*x3^3 - 688.74373709263795717561151832342*x2*x3^2 - 16.503914011788310745032504200935*x1^3*x3 + 36.11093742661151395623164717108*x2^2*x3 - 49.504719947150121583945292513818*x2*x3^3 + 35.53606561871875157976319314912*x2^3*x3 - 30.401694150258535387365554925054*x1^2 - 5.3782151536740094854849303374067*x1^3 + 19.506985565931945103557154652663*x2^2 - 3.8049673947692759234939785528695*x1^4 - 6.7000840017516072322223408264108*x2^3 - 32.218750030998933198134182021022*x3^2 + 4.2978860093216102455926375114359*x2^4 - 98.075787195619597014228929765522*x3^3 - 24.620249081652652023421978810802*x3^4 - 1.5623419374410065785241386038251*x1*x2*x3^2 - 18.802938910819445794686544104479*x1*x2^2*x3 + 5.5852542321119003077001252677292*x1^2*x2*x3 + 109.54917296771192525284277508035*x1*x2*x3 + 4.5290527758524454782218526815996;
u3 = 42.92002193190409542467023129575*x2 - 0.046062247511640543040645212613526*x1 - 14.654752079614082660441454208922*x3 - 1.0549271341185386674510482407641*x1^2*x2^2 + 5.81652296737180485308726929361*x1^2*x3^2 - 37.147941154928680873581470223144*x2^2*x3^2 - 1.7484891079699811378134199912893*x1*x2 - 51.015599860375218099761696066707*x1*x3 - 7.1087830976223953527437515731435*x2*x3 + 105.53807687815159965794009622186*x1*x2^2 - 0.26876020832028896245802229714172*x1^2*x2 - 12.243596720163797186842202791013*x1*x2^3 - 38.602502423630170369506231509149*x1*x3^2 - 129.8627297701940221941185882315*x1^2*x3 - 13.169904607246225580752252426464*x1^3*x2 - 5.8117476219380570512385020265356*x1*x3^3 - 62.158687573856653330039989668876*x2*x3^2 + 0.55306877159876433047713817359181*x1^3*x3 - 507.02058548451253727762377820909*x2^2*x3 - 15.823887319684223129456768219825*x2*x3^3 + 17.565727903956403821439380408265*x2^3*x3 + 3.8796256544071812122354003804503*x1^2 + 10.729952614161311075235971657094*x1^3 - 34.223995308679711513377696974203*x2^2 - 3.6248107725393308164996142295422*x1^4 + 35.189131302579866655833029653877*x2^3 - 8.4336079255333071813538481364958*x3^2 + 27.125445235383597974987424095161*x2^4 - 10.213255444555461082245528814383*x3^3 + 8.4058624766120946247838219278492*x3^4 + 27.485469220339876272873880225234*x1*x2*x3^2 + 4.077362412268834113149296172196*x1*x2^2*x3 - 10.326010623857554193705254874658*x1^2*x2*x3 + 73.418257061507830485425074584782*x1*x2*x3 - 4.3160071330031470893118239473552;
B = 17365.25447007778348051942884922*x1^2*x3^2 - 772.97762945060708261735271662474*x2 - 950.78283091693867845606291666627*x3 - 11916.79233659101919329259544611*x1^2*x2^2 - 1127.0541170537956077168928459287*x1 + 48290.448345255470485426485538483*x2^2*x3^2 - 291.10539025282906777647440321743*x1*x2 - 702.48498440172909340617479756474*x1*x3 - 368.11648201315580308801145292819*x2*x3 - 2269.024202167850035039009526372*x1*x2^2 + 1023.782165231908606983779463917*x1^2*x2 - 3071.4743898837432425352744758129*x1*x2^3 + 4900.2261525390222232090309262276*x1*x3^2 + 728.82409038436787795944837853312*x1^2*x3 - 1377.9554799214677132113138213754*x1^3*x2 + 2429.2209307250018355262000113726*x1*x3^3 - 1392.8009350646709663124056532979*x2*x3^2 - 87.616144222155440957067185081542*x1^3*x3 + 1195.3361341340955732448492199183*x2^2*x3 - 1357.9066509522849628410767763853*x2*x3^3 + 1084.0180135997206889442168176174*x2^3*x3 - 237.52272231029201066121459007263*x1^2 - 1207.707956565701806539436802268*x1^3 + 246.64502890328370199313212651759*x2^2 - 3796.7118930366918903018813580275*x1^4 + 1338.475598779357369494391605258*x2^3 - 445.46831620041626820238889195025*x3^2 - 19110.490099057598854415118694305*x2^4 - 949.69843786950161756976740434766*x3^3 - 32343.761161970262037357315421104*x3^4 + 3803.5504555278575935517437756062*x1*x2*x3^2 - 1999.6906956040857039624825119972*x1*x2^2*x3 + 211.10160515196014330285834148526*x1^2*x2*x3 + 377.08242543314162276146817021072*x1*x2*x3 + 157361.34696154913399368524551392;
%%
c0 = 1; cc = 1.1; epsi = 1e-6; N_Lya = [];
%%
figure(figure_id);clf;hold on;
ph2= patch(pcontour3(C2,0,domain,'c')); set(ph2, 'FaceColor', 'none', 'EdgeColor', 'k' );
ph3= patch(pcontour3(C3,0,domain,'c')); set(ph3, 'FaceColor', 'none', 'EdgeColor', 'k' );
ph4= patch(pcontour3(C4,0,domain,'c')); set(ph4, 'FaceColor', 'none', 'EdgeColor', 'k' );
phV0= patch(pcontour3(V0,double(CC0),domain,'G')); set(phV0,'EdgeAlpha',1, 'FaceColor', 'none', 'EdgeColor', 'g' );
phB= patch(pcontour3(B,0,domain,'B')); set(phB,'EdgeAlpha',0.3,'FaceColor', 'none', 'EdgeColor', 'b','LineStyle','-','LineWidth',1);
xlim([-dom dom]); ylim([-dom dom]); zlim([-dom dom]); view(-100,0);
%% Hyperparameters of the SOSP @ CBF -> V
V_us = 4; V_au = 6; V_degree = 4; gamma = 0;
k_u_V = 4; k_l_au = 4;
%%
kk = 1; OO = 0;
%%
[V, kk] = sos_optimal_V1_3D_V(f,gg,B,u1,u2,u3,V_au,V_us,V_degree,C,gamma);
%%
if kk == 0
    fprintf('Suitable Lyapunov function can not find.======\n');
end
N_Lya = [N_Lya;V];
%% TEST FOR Sublevel Set
[a1,b1] = coeffs(p2s(V));
ccc = double(vpa(a1(end)));
C0 = ccc; cc = ccc+1;solU = []; v_c = []; iter = 0;
%%
figure(figure_id);hold on;
%%
while double(cc)-double(C0) >= epsi
    iter = iter + 1;
    if iter ~= 0
        C0 = cc;
    end
    [solL,kk]= sos_optimal_v2_3D(f,gg,k_u_V,k_l_au,V,cc);
    if kk == 0
        break
    end
    [cc,kk,solu1,solu2,solu3] = sos_optimal_v3_3D(f,gg,k_u_V,k_l_au,V,C,dom,solL,ccc,figure_id);
    v_c = [v_c; double(cc)]
    solU = [solU;[solu1,solu2,solu3]];
end
%% Start to compute the control barrier function
c_b = max(double(v_c));
V = N_Lya(end); A_V = [A_V;V]; A_C0 = [A_C0; double(c_b)]; sol_B = c_b - N_Lya(end);
hold on; phsol_B = patch(pcontour3(sol_B,0,domain,'B')); set(phsol_B,'EdgeAlpha',0.8,'FaceColor', 'none', 'EdgeColor', 'r','LineStyle','-','LineWidth',1);
%%
fprintf('Optimal $V^*(x)$ is \n%s \n\n',char(vpa(p2s(V))));
fprintf('Sublevel set of $V^*(x)$ is %.14f. \n',max(v_c));
