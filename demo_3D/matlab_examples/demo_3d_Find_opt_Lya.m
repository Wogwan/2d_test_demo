clear;
pvar x1 x2 x3 u1 u2 u3 htol epsi;
format long
x = [x1;x2;x3];
%%
f = [-0.16211179709864792508611230914539*x1^4+0.46967680241313530098423711933719*x1^3-0.80741059859268821864900068453951*x1^2-0.52420770456533548609101558213297*x1-0.000031796033448678815965058458425929*x2^4+0.00049811603934539429219124917480599*x2^3-0.017884574789259536503616132563366*x2^2+0.059003602596920091960530641017613*x2+0.14736298331076760903535216584714*x3^4-0.22234685217253638556123007674614*x3^3+0.14008297734444075111071015271591*x3^2+0.34076230832989312657943514750514*x3-1.4865840251312778030530597727999
    -x2*x1^3-x2
    1.876321954439673866943394386908*x1^4-1.8803947547684580765547934788628*x1^3-x1^2*x3-0.3521313244010295662178577913437*x1^2-0.58570314276461321600919518459705*x1+0.0008606977977094753011130801034767*x2^4-0.0047246616639717428295930368165045*x2^3+0.0073970075005580443808228530144788*x2^2-0.39277632595769917944750204696902*x2-6.3527586089398613289347395038931*x3^4+9.1026400980830752818206974552595*x3^3+5.2275118144867558367394622109714*x3^2-10.044858323825100132609122738359*x3+0.61281374087452245014162599545671
    ];
gg = [1;1;1];
sys = [f(1)+gg(1)*u1; f(2)+gg(2)*u2; f(3)+gg(3)*u3];
%%
dom = 10; domain = [-dom dom -dom dom -dom dom];
C1 = (x1-3)^2+(x2-0)^2+(x3-0)^2-2;
C2 = (x1+4)^2+(x2+4)^2+(x3-4)^2-4;
C3 = (x1-0)^2+(x2-4)^2+(x3+0)^2-4;
C4 = (x1-4)^2+(x2-0)^2+(x3+4)^2-6;
%%
C = [C2;C3;C4];
V0 = 1*x1^4+1*x2^4+1*x3^4+1*x1^2*x2^2+1*x3^2*x2^2+1*x1^2*x3^2;
CC0 = 16.00000001852458;
%%
figure_id = 211;
A_V = [];
A_C0 = [];
%% Start to compute the control barrier function
u1 = 0.0036278078235016113402278126187639*x1^2*x3^2 - 0.074853851629630832609230139951251*x2 - 0.33860290663883874096029558131704*x3 - 0.0056196917776019858492553282758308*x1^2*x2^2 - 9.1693249063600443804489259491675*x1 + 0.0070017847320272127639717574254519*x2^2*x3^2 - 0.00080979161746908023301882995070855*x1*x2 + 0.0040915426044096656413295853838008*x1*x3 + 0.0028817776997318669297831750242267*x2*x3 - 8.825976626509822509092373366002*x1*x2^2 + 0.21237199151021782239645574463793*x1^2*x2 - 0.0014867036971504532776727769416425*x1*x2^3 - 1.6020880929003389336884310978348*x1*x3^2 - 0.032424128834477428107163632375887*x1^2*x3 - 0.012371521920574061331743465075306*x1^3*x2 - 0.0074825773325913362207795209712913*x1*x3^3 - 0.16707773119136673511953006254771*x2*x3^2 + 0.0063138184447398791598882183961905*x1^3*x3 - 0.5182259977700368613895420821791*x2^2*x3 + 0.00084277107472266910449115728809488*x2*x3^3 + 0.00052601592126017850635510963996921*x2^3*x3 + 0.79586956440336276141778171222541*x1^2 - 0.43693443706949741667244779819157*x1^3 + 0.014434245013645898708665171739085*x2^2 + 0.15211225616194504195455294848216*x1^4 + 0.23548149658358186187001592770685*x2^3 - 0.13108866885487063802528950873239*x3^2 + 0.0037698673556412045163033219807858*x2^4 + 0.31140627024130951294722535749315*x3^3 - 0.14784994600680922971491781936493*x3^4 + 0.014350020598274976224573151739605*x1*x2*x3^2 + 0.0044279426160087941369281061554375*x1*x2^2*x3 - 0.0011179373869161781870906757774264*x1^2*x2*x3 - 0.46934346099781248939919464646664*x1*x2*x3 + 1.4871269556259623101368561037816;
u2 = 0.008395078191120654287349367450588*x3 - 8.5566909642537734015377282048576*x2 - 0.017577587167833429865337890873889*x1 - 0.01109744265826814214881412823388*x1^2*x2^2 + 0.0060395408881024651923108415019215*x1^2*x3^2 + 0.0067889716325569013713470134518957*x2^2*x3^2 - 0.001710632257506078867867471693387*x1*x2 + 0.0032927038840403128651390662895437*x1*x3 + 0.0030419185181096240061515700858763*x2*x3 + 0.24293966629604993312518956827262*x1*x2^2 - 9.3611878758091080499070812948048*x1^2*x2 + 0.0087885935892798583424223579640966*x1*x2^3 - 0.1933146404892521208473965543817*x1*x3^2 - 0.56023580584121468461944459704682*x1^2*x3 + 0.97514175118170576261888982116943*x1^3*x2 + 0.0011998085814183890359524431445948*x1*x3^3 - 0.95461590807724339136086655344116*x2*x3^2 - 0.0014177655059564853428505371013557*x1^3*x3 - 0.02305465987979268480123629103673*x2^2*x3 - 0.0038838132780550185287060660499492*x2*x3^3 - 0.0027185526122860503676903487502159*x2^3*x3 - 0.0097338295883019256699020260725774*x1^2 + 0.24614177753990659769378623877856*x1^3 - 0.0026830420516468565621248654196052*x2^2 - 0.0024549092428157188311432790328581*x1^4 - 0.20218480804165181452525246186269*x2^3 + 0.011988839865053864744415257348464*x3^2 + 0.0012173296709401689418006409226791*x2^4 + 0.089212714531886075364219834682444*x3^3 - 0.000498643014313632096726203180026*x3^4 + 0.013869709373062632032369556611684*x1*x2*x3^2 + 0.00048530608266593986722947651202276*x1*x2^2*x3 + 0.010529258136145639573877375028133*x1^2*x2*x3 - 0.49800293439578996457228754479729*x1*x2*x3 + 0.000057432468932313405379254389604426;
u3 = 0.38329541026667829362040151863766*x1 + 0.16198156665595322967199365393753*x2 - 6.5577439559433354787643111194484*x3 + 0.00067468567687542686534679647891721*x1^2*x2^2 + 0.012264476263955312318465473708784*x1^2*x3^2 + 0.0016648402060996112319934958634349*x2^2*x3^2 + 0.0012674879706448009472619098403356*x1*x2 - 0.0027395013681100512104027444593157*x1*x3 - 0.0073275008585643383596242017574696*x2*x3 - 0.15197171643879175961799887772941*x1*x2^2 - 0.077564347162625932319279797866329*x1^2*x2 - 0.00055385281347780450887652303748609*x1*x2^3 + 0.073448377409301587870338323682518*x1*x3^2 - 3.0296178486231561954866720043356*x1^2*x3 - 0.00036233894265554441498425330969724*x1^3*x2 + 0.011603548894876698771572165469479*x1*x3^3 - 0.013671067982330710119387440215633*x2*x3^2 - 0.0096577442240843337784017563762973*x1^3*x3 - 4.0202360313281406689611685578711*x2^2*x3 + 0.014457846747437934353808230980576*x2*x3^3 + 0.0081837814113135520094344244057538*x2^3*x3 + 0.35311123124089155433935616201779*x1^2 + 1.6528493595844699903807395457989*x1^3 - 0.021035754083542711201371133711291*x2^2 - 1.8665791517677396971208736431436*x1^4 - 0.19537747409348701910225543088018*x2^3 - 5.2134673696527391584254473855253*x3^2 - 0.0069593261512520361231071142071869*x2^4 - 10.549856001519765769103287311736*x3^3 + 6.3381305553446747325097021530382*x3^4 + 0.0014808231880560575235289411111239*x1*x2*x3^2 - 0.0060724679514577066877234479136405*x1*x2^2*x3 - 0.025414307306656100382546981109044*x1^2*x2*x3 + 0.16689937756027239945666451603756*x1*x2*x3 - 0.6130751850817334203114228330378;
B = 0.0000017236363428663207474192441484573*x1 - 0.0000000077437123412664019499490906722414*x2 + 0.0000034495214506427559767918165911649*x3 + 228.60778058066256335223442874849*x1^2*x2^2 + 6.0389982357794851353105514135677*x1^2*x3^2 + 2.8131878277724782222435351286549*x2^2*x3^2 + 0.033863942589641170266556713386308*x1*x2 - 0.059399306858147510324030804440554*x1*x3 - 0.06302847912072079283873904387292*x2*x3 + 0.022510577134928596437779546590718*x1*x2^2 - 0.017104681977074490811796536604561*x1^2*x2 - 0.1685709601351687292325465250542*x1*x2^3 - 0.0028695409243534595114533125581602*x1*x3^2 - 0.026223107364553188691758123241016*x1^2*x3 - 0.075129388526391407965299151783256*x1^3*x2 - 0.16134330438465774304468425270898*x1*x3^3 - 0.0080939770259480115638384134513217*x2*x3^2 + 0.017648832384881005252985630704643*x1^3*x3 - 0.018885982318318211142793572321352*x2^2*x3 - 0.11648591531578200708452186518116*x2*x3^3 + 0.21289585093660753911670724392025*x2^3*x3 - 0.051122404011446742622126748756273*x1^2 - 0.011385288326670378600269373237097*x1^3 - 0.064448490295723970255892254499486*x2^2 - 117.4699224581297016811731737107*x1^4 + 0.032663854921584169199721969789607*x2^3 - 0.15438525273060046960615920852433*x3^2 - 115.62088824667073083674040390179*x2^4 + 0.033690158532888370146451961772982*x3^3 - 4.8791364580315432775137196586002*x3^4 + 0.14674156157763398877769134287519*x1*x2*x3^2 + 0.26027763367423373264131214455119*x1*x2^2*x3 + 0.024183829808693074747694140569365*x1^2*x2*x3 - 0.0072930991491366769022275384770637*x1*x2*x3 + 57.034862378182857867159327724949;
%%
c0 = 1; cc = 1.1; epsi = 1e-6; N_Lya = [];
%%
figure(figure_id);clf;hold on;
ph2= patch(pcontour3(C2,0,domain,'c')); set(ph2, 'FaceColor', 'none', 'EdgeColor', 'k' );
ph3= patch(pcontour3(C3,0,domain,'c')); set(ph3, 'FaceColor', 'none', 'EdgeColor', 'k' );
ph4= patch(pcontour3(C4,0,domain,'c')); set(ph4, 'FaceColor', 'none', 'EdgeColor', 'k' );
phV0= patch(pcontour3(V0,double(CC0),domain,'G')); set(phV0,'EdgeAlpha',1, 'FaceColor', 'none', 'EdgeColor', 'g' );
phB= patch(pcontour3(B,0,domain,'B')); set(phB,'EdgeAlpha',0.3,'FaceColor', 'none', 'EdgeColor', 'b','LineStyle','-','LineWidth',1);
xlim([-dom dom]); ylim([-dom dom]); zlim([-dom dom]); view(-100,0);
%% Hyperparameters of the SOSP @ CBF -> V
V_us = 4; V_au = 4; V_degree = 4; gamma = 0;
k_u_V = 4; k_l_au = 4;
%%
kk = 1; OO = 0;
%%
[V, kk] = sos_optimal_V1_3D_V(f,gg,B,u1,u2,u3,V_au,V_us,V_degree,C,gamma);
%%
if kk == 0
    fprintf('Suitable Lyapunov function can not find.======\n');
end
N_Lya = [N_Lya;V];
%% TEST FOR Sublevel Set
[a1,b1] = coeffs(p2s(V));
ccc = double(vpa(a1(end)));
C0 = ccc; cc = ccc+1;solU = []; v_c = []; iter = 0;
%%
figure(figure_id);hold on;
%%
while double(cc)-double(C0) >= epsi
    iter = iter + 1;
    if iter ~= 0
        C0 = cc;
    end
    [solL,kk]= sos_optimal_v2_3D(f,gg,k_u_V,k_l_au,V,cc);
    if kk == 0
        break
    end
    [cc,kk,solu1,solu2,solu3] = sos_optimal_v3_3D(f,gg,k_u_V,k_l_au,V,C,dom,solL,ccc,figure_id);
    v_c = [v_c; double(cc)]
    solU = [solU;[solu1,solu2,solu3]];
end
%% Start to compute the control barrier function
c_b = max(double(v_c));
V = N_Lya(end); A_V = [A_V;V]; A_C0 = [A_C0; double(c_b)]; sol_B = c_b - N_Lya(end);
hold on; phsol_B = patch(pcontour3(sol_B,0,domain,'B')); set(phsol_B,'EdgeAlpha',0.8,'FaceColor', 'none', 'EdgeColor', 'r','LineStyle','-','LineWidth',1);
%%
fprintf('Optimal $V^*(x)$ is \n%s \n\n',char(vpa(p2s(V))));
fprintf('Sublevel set of $V^*(x)$ is %.14f. \n',max(v_c));
