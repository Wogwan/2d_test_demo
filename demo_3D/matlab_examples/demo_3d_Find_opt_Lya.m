clear;
pvar x1 x2 x3 u1 u2 u3 htol epsi;
format long
x = [x1;x2;x3];
%%
f = [-0.16211179709695037165964324641892*x1^4+0.49031898059485488031675707268867*x1^3-0.80741059860165544525334054266171*x1^2-0.67918469453797989758096302163419*x1-0.000031796033448678815965058458425929*x2^4+0.00049811603934539429219124917480599*x2^3-0.017884574789259536503616132563366*x2^2+0.059003602596920091960530641017613*x2+0.14736298331076760903535216584714*x3^4-0.22234685217253638556123007674614*x3^3+0.14008297734444075111071015271591*x3^2+0.34076230832989312657943514750514*x3-1.4865840251194628709408125437986
    -x2*x1^3-x2
    1.876321954439673866943394386908*x1^4-1.8803947547684580765547934788628*x1^3-x1^2*x3-0.3521313244010295662178577913437*x1^2-0.58570314276461321600919518459705*x1+0.0008606977977094753011130801034767*x2^4-0.0047246616639717428295930368165045*x2^3+0.0073970075005580443808228530144788*x2^2-0.39277632595769917944750204696902*x2-0.63399852647351906398398568853736*x3^4-2.3526877462367330462456038731034*x3^3-0.18912599086086179234200699283974*x3^2-1.2624646738177363047839207865763*x3+1.2361363889678920191528277428006
    ];
gg = [1;1;1];
sys = [f(1)+gg(1)*u1; f(2)+gg(2)*u2; f(3)+gg(3)*u3];
%%
dom = 10; domain = [-dom dom -dom dom -dom dom];
C1 = (x1-3)^2+(x2-0)^2+(x3-0)^2-2;
C2 = (x1+2)^2+(x2+3)^2+(x3-3)^2-3;
C3 = (x1-0)^2+(x2-3)^2+(x3+0)^2-3;
C4 = (x1-3)^2+(x2-0)^2+(x3+3)^2-4;
C = [C2;C3;C4];
V0 = 1*x1^4+1*x2^4+1*x3^4+1*x1^2*x2^2+1*x3^2*x2^2+1*x1^2*x3^2;
CC0 = 2.584683714740699;
figure_id = 211;
A_V = [];
A_C0 = [];
%% Start to compute the control barrier function
B = 0.092591058445305143842496420347743*x1 + 0.092066991638142914311515596637037*x2 - 0.0095325653992387737734048869242542*x3 + 2067.1706964880281702789943665266*x1^2*x2^2 + 1031.9564402236233036092016845942*x1^2*x3^2 + 1873.2836014859005899779731407762*x2^2*x3^2 - 65.003898242846602784084097947925*x1*x2 + 6.9827646261060314358815048763063*x1*x3 + 6.8345209766433292486453865421936*x2*x3 + 158.70882545620787595908041112125*x1*x2^2 + 85.123268826514603802024794276804*x1^2*x2 - 13.797674071336695433842578495387*x1*x2^3 - 80.159318863606344507388712372631*x1*x3^2 - 17.91356022817915416567302600015*x1^2*x3 + 28.634167730361326675847521983087*x1^3*x2 + 72.046693851528928576044563669711*x1*x3^3 - 79.987312779691947639548743609339*x2*x3^2 - 45.186312638178108613828953821212*x1^3*x3 - 75.153571346762959137777215801179*x2^2*x3 + 57.589993481410935771691583795473*x2*x3^3 + 11.659753752924713054994754202198*x2^3*x3 - 32.738863487459397560996876563877*x1^2 + 31.49345325147634611084868083708*x1^3 - 32.421275614815598942186625208706*x2^2 - 1547.2610555843077690951758995652*x1^4 + 104.82452673825659417161659803241*x2^3 - 4.7345880170375354012435309414286*x3^2 - 1997.2115892740769140800694003701*x2^4 + 48.573505060159916979500849265605*x3^3 - 1508.8790118663650900998618453741*x3^4 - 88.059059562867602721780713181943*x1*x2*x3^2 + 26.492917027990298350914599723183*x1*x2^2*x3 - 15.808122604412655931582776247524*x1^2*x2*x3 - 45.896211952712810955290478887036*x1*x2*x3 + 4874.0267960828687137109227478504;
u1 = 83.451342483209813849498459603637*x2 - 1904.3567736398595116042997688055*x1 + 16.771785587816257390159080387093*x3 - 50.504010290820176010129216592759*x1*x2 + 6.1706707171031665026816881436389*x1*x3 + 4.3467622859730044027060102962423*x2*x3 - 32.312213519952834417381382081658*x1^2 - 23.799424398357636789569369284436*x2^2 + 6.4361150886026674555751014850102*x3^2 + 1.3811777347053408870891644255607;
u2 = 111.05691249142537913030537310988*x1 - 1872.0179261585578842641552910209*x2 - 25.236023425976249257018935168162*x3 - 50.493832672436241182367666624486*x1*x2 + 6.626756055753683760656258527888*x1*x3 + 8.6767051156680601309290068456903*x2*x3 - 20.835131248380342583459423622116*x1^2 - 38.792763587120361989946104586124*x2^2 + 5.1053372929633873411603417480364*x3^2 + 2.6651952561664602470159479707945;
u3 = 53.941982743271850608834938611835*x1 + 26.827725464731717153199497261085*x2 - 1972.7897801516653544240398332477*x3 + 4.1439672126206508195878086553421*x1*x2 - 45.879255708769974830829596612602*x1*x3 - 45.759008793112286639370722696185*x2*x3 - 7.2638592314291470231069069996011*x1^2 + 2.4596684349291599858133849920705*x2^2 + 7.0115621450968337313724987325259*x3^2 - 1.2555282440666193366496372618712;
%%
c0 = 1; cc = 1.1; epsi = 1e-6; N_Lya = [];
%%
figure(figure_id);clf;hold on;
ph2= patch(pcontour3(C2,0,domain,'c')); set(ph2, 'FaceColor', 'none', 'EdgeColor', 'k' );
ph3= patch(pcontour3(C3,0,domain,'c')); set(ph3, 'FaceColor', 'none', 'EdgeColor', 'k' );
ph4= patch(pcontour3(C4,0,domain,'c')); set(ph4, 'FaceColor', 'none', 'EdgeColor', 'k' );
phV0= patch(pcontour3(V0,double(CC0),domain,'G')); set(phV0,'EdgeAlpha',1, 'FaceColor', 'none', 'EdgeColor', 'g' );
phB= patch(pcontour3(B,0,domain,'B')); set(phB,'EdgeAlpha',0.3,'FaceColor', 'none', 'EdgeColor', 'b','LineStyle','-','LineWidth',1);
xlim([-dom dom]); ylim([-dom dom]); zlim([-dom dom]); view(-100,0);
%% Hyperparameters of the SOSP @ CBF -> V
V_us = 2; V_au = 4; V_degree = 4; gamma = 0;
k_u_V = 2; k_l_au = 4;
%%
kk = 1; OO = 0;
%%
[V, kk] = sos_optimal_V1_3D_V(f,gg,B,u1,u2,u3,V_au,V_us,V_degree,C,gamma);
%%
if kk == 0
    fprintf('Suitable Lyapunov function can not find.======\n');
end
N_Lya = [N_Lya;V];
%% TEST FOR Sublevel Set
[a1,b1] = coeffs(p2s(V));
ccc = double(vpa(a1(end)));
C0 = ccc; cc = ccc+1;solU = []; v_c = []; iter = 0;
%%
figure(figure_id);hold on;
%%
while double(cc)-double(C0) >= epsi
    iter = iter + 1;
    if iter ~= 0
        C0 = cc;
    end
    [solL,kk]= sos_optimal_v2_3D(f,gg,k_u_V,k_l_au,V,cc);
    if kk == 0
        break
    end
    [cc,kk,solu1,solu2,solu3] = sos_optimal_v3_3D(f,gg,k_u_V,k_l_au,V,C,dom,solL,ccc,figure_id);
    v_c = [v_c; double(cc)]
    solU = [solU;[solu1,solu2,solu3]];
end
%% Start to compute the control barrier function
c_b = max(double(v_c));
V = N_Lya(end); A_V = [A_V;V]; A_C0 = [A_C0; double(c_b)]; sol_B = c_b - N_Lya(end);
hold on; phsol_B = patch(pcontour3(sol_B,0,domain,'B')); set(phsol_B,'EdgeAlpha',0.8,'FaceColor', 'none', 'EdgeColor', 'r','LineStyle','-','LineWidth',1);
%%
fprintf('Optimal $V^*(x)$ is \n%s \n\n',char(vpa(p2s(V))));
fprintf('Sublevel set of $V^*(x)$ is %.14f. \n',max(v_c));
