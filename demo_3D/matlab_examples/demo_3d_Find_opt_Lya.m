clear; load BC_test;
pvar x1 x2 x3 u1 u2 u3 htol epsi;
format long
x = [x1;x2;x3];
%%
for i = 1:length(A)
    f = [-0.16211179709695037165964324641892*x1^4+0.49031898059485488031675707268867*x1^3-0.80741059860165544525334054266171*x1^2-0.67918469453797989758096302163419*x1-0.000031796033448678815965058458425929*x2^4+0.00049811603934539429219124917480599*x2^3-0.017884574789259536503616132563366*x2^2+0.059003602596920091960530641017613*x2+0.14736298331076760903535216584714*x3^4-0.22234685217253638556123007674614*x3^3+0.14008297734444075111071015271591*x3^2+0.34076230832989312657943514750514*x3-1.4865840251194628709408125437986
        -x2*x1^3-x2
        1.876321954439673866943394386908*x1^4-1.8803947547684580765547934788628*x1^3-x1^2*x3-0.3521313244010295662178577913437*x1^2-0.58570314276461321600919518459705*x1+0.0008606977977094753011130801034767*x2^4-0.0047246616639717428295930368165045*x2^3+0.0073970075005580443808228530144788*x2^2-0.39277632595769917944750204696902*x2-0.63399852647351906398398568853736*x3^4-2.3526877462367330462456038731034*x3^3-0.18912599086086179234200699283974*x3^2-1.2624646738177363047839207865763*x3+1.2361363889678920191528277428006
        ];
    gg = [1;1;1];
    sys = [f(1)+gg(1)*u1; f(2)+gg(2)*u2; f(3)+gg(3)*u3];
    c0 = 1; cc = 1.1; epsi = 1e-6; figure_id = 211; N_Lya = [];
    %%
    C1 = (x1+4)^2+(x2-6)^2+(x3+2)^2-4;
    C2 = (x1+3)^2+(x2+4)^2+(x3+4)^2-4;
    C3 = (x1-4)^2+(x2-0)^2+(x3-0)^2-5;
    C4 = (x1+4)^2+(x2-2)^2+(x3-4)^2-5;
    C = [C1;C2;C3;C4];
    V0 = 10*x1^4+1*x2^4+20*x3^4+2*x1^2*x2^2-4*x3^2*x2^2+3*x1^2*x3^2;
%     C0 = 96.811595465770495;
    C0 = 96.811595218740692;
    %% Start to compute the control barrier function 21
    % u1 = 0.34962855808541298818781228874286*x1^4 + 0.080061506467689974586576795445581*x1^3*x2 + 0.11084065346127917883745084282054*x1^3*x3 + 0.93993158099082807499513592119911*x1^3 - 0.067017788351637880284172865685832*x1^2*x2^2 + 0.13536242729794045747127029244439*x1^2*x2*x3 + 0.090982608638759038255372502135288*x1^2*x2 - 0.85812372993650232189111193292774*x1^2*x3^2 - 1.7690330548579555891564041303354*x1^2*x3 + 0.67234154795775791235712404159131*x1^2 - 0.012810887918566488466454167394204*x1*x2^3 - 0.10135325050102106381189059902681*x1*x2^2*x3 - 3.7228751360114333834872013540007*x1*x2^2 - 0.070522515021820969538524082054209*x1*x2*x3^2 + 11.512975327870172748134791618213*x1*x2*x3 - 0.0016630423625145669686009597398879*x1*x2 - 0.01369275035500480339201168078489*x1*x3^3 - 31.817288089101353421028761658818*x1*x3^2 - 0.37648415954017616646964938809106*x1*x3 - 15.13914272357563994830798037583*x1 + 0.065951455438156766919455264996941*x2^4 + 0.031085726533344872762887334260995*x2^3*x3 + 0.35272883322204595657467507408001*x2^3 - 0.1862870170064923613928442591714*x2^2*x3^2 + 1.5258316955428250505377718582167*x2^2*x3 + 0.20408904672458696993864180058154*x2^2 - 0.3543350330168821837872883406817*x2*x3^3 - 0.31863052143194331433662114250183*x2*x3^2 - 0.53472080212922323827484660796472*x2*x3 + 0.016134066078902626478752679872741*x2 + 0.52508292892579744304271116561722*x3^4 - 2.4175335530673027761849880334921*x3^3 - 2.6362123679911326767921764258062*x3^2 - 0.81845688324581578054761621388025*x3 + 1.4759513782661983771760105810245;
    % u2 = - 0.7336911743393679241620475295349*x1^4 + 0.83406760694234705066918422744493*x1^3*x2 + 0.13538176945697996678141805659834*x1^3*x3 + 1.0929239992045960416788830116275*x1^3 - 0.067231113714748602649962094801595*x1^2*x2^2 + 0.80985008245285472483487865247298*x1^2*x2*x3 - 27.037161483143279383511980995536*x1^2*x2 + 2.174372702500179332929519659956*x1^2*x3^2 + 16.422677082265714432196546113119*x1^2*x3 + 0.13443881524271797389680216383567*x1^2 + 0.025749111092653119425843755152528*x1*x2^3 - 0.023659266512415139810387998409169*x1*x2^2*x3 + 4.6690509305050049704277626005933*x1*x2^2 - 0.10093155800599290516927908356593*x1*x2*x3^2 - 3.5205846874828998771533861145144*x1*x2*x3 + 2.4062111596448949590865140635287*x1*x2 - 0.35522599143729843840233684204577*x1*x3^3 - 5.8866955279875847750759021437261*x1*x3^2 + 4.6240075915557223851237722556107*x1*x3 + 1.1278945851947226319822448203922*x1 - 0.070416667621168535506903651821631*x2^4 - 0.13210412082816685996888850240794*x2^3*x3 - 10.956881099561474712800190900452*x2^3 + 0.23352185812291281763464212417603*x2^2*x3^2 - 1.9842894817041833999127220522496*x2^2*x3 + 0.2041421965050744802283588796854*x2^2 - 0.56743452422250251210300575621659*x2*x3^3 + 4.5458578848604620503692785860039*x2*x3^2 + 0.11029578459888518537912460715233*x2*x3 - 19.532685874846329454612714471295*x2 - 1.4249722950135477184119281446328*x3^4 - 1.6239712998669995069889182559564*x3^3 + 0.46330935157172692395732838122058*x3^2 - 2.7788667008354219767340964608593*x3 - 0.0004355325268490709109299452439501;
    % u3 = - 1.9237438826406034753091489619692*x1^4 - 0.20325871836528947023126079329813*x1^3*x2 - 0.94363745250504926787016302114353*x1^3*x3 + 0.038894840904496581768245988541821*x1^3 - 0.015306998155893591917475760055822*x1^2*x2^2 - 0.08570592216259395601518633611704*x1^2*x2*x3 + 11.359210887512835697066293505486*x1^2*x2 + 0.058759299662120186014124811890724*x1^2*x3^2 - 30.026890207723539560902281664312*x1^2*x3 - 0.069951496799910278800993523873331*x1^2 + 0.086696959149812777289945131542481*x1*x2^3 - 0.016840749609945138143274334652233*x1*x2^2*x3 + 1.8007622965150169580539341041003*x1*x2^2 - 0.040202107767313415009891031104416*x1*x2*x3^2 + 0.10656334120573339452331396159934*x1*x2*x3 - 0.67786179021061809812920273543568*x1*x2 + 0.80660123748458278924999831360765*x1*x3^3 - 2.8161177171339457636634051596047*x1*x3^2 - 2.5622559207940680536808031320106*x1*x3 + 0.072592005298113757016942315658525*x1 + 0.054783175338534405296453400069367*x2^4 + 0.028211023493602740280783436332968*x2^3*x3 + 0.31394210545394601874491513626708*x2^3 - 0.15000816653954390789138528816693*x2^2*x3^2 - 1.4669120211302724143820341851097*x2^2*x3 - 0.0029259470843899901444651323600965*x2^2 + 0.055435383124456991121853377535444*x2*x3^3 - 0.098307558602162337102470246463781*x2*x3^2 - 0.044496990400635788587280217143416*x2*x3 + 0.49286078294833746138436936234939*x2 + 0.72948413293663827428048307410791*x3^4 + 0.94793474197296634375931034810492*x3^3 + 0.20101993470399787122815382645058*x3^2 - 14.439753732468936675559234572574*x3 - 1.2367345415044519452152371741249;
    % B = - 273.39650242684382419611210934818*x1^4 + 3.2589263027938537575778354948852*x1^3*x2 + 3.3562511580000289335146135272225*x1^3*x3 - 0.015310159136399738993850050405854*x1^3 + 49.560606565764210529323463561013*x1^2*x2^2 - 5.6863118500645093433831789297983*x1^2*x2*x3 - 1.839760885155375058630511375668*x1^2*x2 + 492.75971320250397411655285395682*x1^2*x3^2 - 1.5992531329666697104130435036495*x1^2*x3 - 0.06476811099359396084462758835798*x1^2 - 4.4810995274363758511526611982845*x1*x2^3 - 4.1790204996910276236121717374772*x1*x2^2*x3 + 1.897106711113640820087766769575*x1*x2^2 + 1.9410588550273071284379966527922*x1*x2*x3^2 + 4.6231191532671704891299668815918*x1*x2*x3 + 0.178092708725241050116139263082*x1*x2 + 1.5480254619169324659111453001969*x1*x3^3 + 2.7257282965782598793680335802492*x1*x3^2 + 0.12158874575605656265242515701175*x1*x3 - 0.000081013903294964385772697346155269*x1 - 16.986346934193537805413143360056*x2^4 + 2.7918880650780653063236513844458*x2^3*x3 + 1.7519110948437255359522168873809*x2^3 - 16.66612225822484916193388926331*x2^2*x3^2 + 1.182358264011557746897551623988*x2^2*x3 - 0.87342702549842854420347748600761*x2^2 - 3.6388353511441993148878282227088*x2*x3^3 - 0.58096981620094623188776949973544*x2*x3^2 - 0.69804408467847633978919930086704*x2*x3 + 0.000012981585341486740300303084905131*x2 - 241.85695481156326991367677692324*x3^4 - 0.27175859700355692316620093151869*x3^3 - 0.16597403855979686593258293214603*x3^2 + 0.000041307146010535933280515691334855*x3 + 694.5013932663647437948384322226;
    %% Start to compute the control barrier function 22
    % u1 = 0.1621034094553742*x1^4-0.001806955821403312*x1^3*x2+0.1155440459847233*x1^3*x3-0.006364000252818122*x1^2*x2^2-0.1760580445661391*x1^2*x2*x3-0.06754290424651813*x1^2*x3^2+2.55851399470228e-05*x1*x2^3-0.005216094681505102*x1*x2^2*x3+0.00182736582310909*x1*x2*x3^2-0.1104087828920595*x1*x3^3+0.0007077644950065401*x2^4+0.007395626168930482*x2^3*x3+0.008288897026465248*x2^2*x3^2+0.1683877502494918*x2*x3^3-0.08280421079842359*x3^4-0.4906364475518927*x1^3-0.003700005354658346*x1^2*x2+0.05913544425496394*x1^2*x3-0.08980014830436164*x1*x2^2+0.1788112525117517*x1*x2*x3-1.733399609942536*x1*x3^2+0.0002457280380927588*x2^3+0.03153623865460885*x2^2*x3-0.002490418022505712*x2*x3^2+0.1708300657056288*x3^3+0.8068357638657349*x1^2-0.0005276916472029738*x1*x2-0.006015879736147749*x1*x3+0.01737929891562224*x2^2-0.004615214427671638*x2*x3-0.1442949079526415*x3^2+0.6739227600489203*x1-0.05900067995509159*x2-0.3406998084063549*x3+1.486584275714113;
    % u2 = -0.03965414964194592*x1^4+0.8612222309041339*x1^3*x2-0.3011529124521751*x1^3*x3-0.002130809551295013*x1^2*x2^2+0.0331237229527312*x1^2*x2*x3+0.179957980803971*x1^2*x3^2+0.006146162737857016*x1*x2^3+0.01290385790034796*x1*x2^2*x3+0.1321270720132464*x1*x2*x3^2+0.2878251402269499*x1*x3^3-0.0001885052612327724*x2^4-0.001977053060580758*x2^3*x3-0.001830994347807943*x2^2*x3^2-0.0309384282742317*x2*x3^3-0.1359753469802434*x3^4-0.0878107446268093*x1^3-1.965874732287918*x1^2*x2+0.03941294119484481*x1^2*x3+0.008940911983108138*x1*x2^2+0.02129695594735256*x1*x2*x3+0.06968755123659522*x1*x3^2-0.1053720937093387*x2^3-0.06022294085474102*x2^2*x3+0.4525600048109631*x2*x3^2+0.3953324290559714*x3^3+0.001179389135155739*x1^2-0.02895424593062904*x1*x2-0.02388475800508775*x1*x3-0.002614652450847317*x2^2+0.003385018876040366*x2*x3+0.01482058343363112*x3^2+0.0008324003771607696*x1+0.9765478010586384*x2-0.01310268698346896*x3+1.063156284428778e-06;
    % u3 = -1.755306522948246*x1^4-0.1700092976621403*x1^3*x2-0.07085248568664661*x1^3*x3-0.00748990139076142*x1^2*x2^2-0.00664047678380776*x1^2*x2*x3-0.1152106429585761*x1^2*x3^2+0.006761804381195219*x1*x2^3+0.002960549470384337*x1*x2^2*x3+0.162961840442244*x1*x2*x3^2+0.06748710963583243*x1*x3^3-0.0006385686954975476*x2^4+0.0005288835136428321*x2^3*x3+0.001411432106740901*x2^2*x3^2+0.006163796915542816*x2*x3^3+0.633965004528346*x3^4+1.942137663062944*x1^3+0.1844672305443435*x1^2*x2-0.8151147415607027*x1^2*x3+0.03181150068325721*x1*x2^2-0.006120142210471182*x1*x2*x3-0.05409547344771466*x1*x3^2+0.006659989376800498*x2^3-0.01666371800942818*x2^2*x3-0.01804624665555309*x2*x3^2+2.351597592361677*x3^3+0.3465436989223841*x1^2-0.003194215199173452*x1*x2-0.003251827805683303*x1*x3-0.007787768658716502*x2^2-0.0006693489882031286*x2*x3+0.1891514553705137*x3^2+0.5857651590121197*x1+0.3932743087378461*x2+1.257804783538485*x3-1.236135702472867;
    % B = -1736956.63672226*x1^4-1831.46561840367*x1^3*x2-1165.419671890035*x1^3*x3+151594.3305487637*x1^2*x2^2-3372.377313719451*x1^2*x2*x3+3321462.069022676*x1^2*x3^2+106.1445945621502*x1*x2^3+39.56929496423027*x1*x2^2*x3+1724.263906984033*x1*x2*x3^2+1122.488952446171*x1*x3^3-5695.94585288409*x2^4+198.3862647861566*x2^3*x3-140179.9360450267*x2^2*x3^2+3152.634718476849*x2*x3^3-1590252.920462937*x3^4+3005.330306412093*x1^3+1910.100059297867*x1^2*x2+2142.38453512091*x1^2*x3-108.7796010393017*x1*x2^2+23.82992042328658*x1*x2*x3-2879.322623075818*x1*x3^2-89.72782076481042*x2^3-89.36523680822386*x2^2*x3-1816.112390893775*x2*x3^2-2051.73829443049*x3^3+10.0328095096463*x1^2-0.5199423501150391*x1*x2-1.522127931991821*x1*x3-5.762779976398856*x2^2-7.642540130131061*x2*x3-16.71172590337951*x3^2-0.01551473333727881*x1-0.0003955426268492361*x2-0.005528050472762131*x3+1739.919907592257;
    u1 = A(i,1);
    u2 = A(i,2);
    u3 = A(i,3);
    B = A(i,4);
    
    %% 26
    %     B = -11154.51967552443*x1^4+1.135913920002194*x1^3*x2+4.955118594070981*x1^3*x3+1171.840078989759*x1^2*x2^2-15.02990601369866*x1^2*x2*x3+21138.95310790373*x1^2*x3^2-6.189653081344577*x1*x2^3-6.041347173501446*x1*x2^2*x3+6.069007291799152*x1*x2*x3^2+2.099288457169987*x1*x3^3-93.09232391138393*x2^4+3.980296472031688*x2^3*x3-987.2454204626316*x2^2*x3^2+1.819554574488895*x2*x3^3-10085.20085196664*x3^4-3.90264724194604*x1^3-2.546733372542181*x1^2*x2-1.748490559079197*x1^2*x3+1.973311313870531*x1*x2^2+7.025110993477067*x1*x2*x3+8.942932559147787*x1*x3^2+2.947834262954737*x2^3+2.575829927090547*x2^2*x3-1.387124471681909*x2*x3^2-1.835427814430669*x3^3-0.08971485448317769*x1^2+0.3095104865629468*x1*x2+0.2408635828835946*x1*x3-1.1949744015814*x2^2-1.317929814293127*x2*x3-0.4552517850754649*x3^2-0.0001426841292988713*x1+0.0001020831374556339*x2+0.0001228298360055396*x3+998.8215452707433;
    
    %%
    figure(figure_id);clf;hold on;
    dom = 15; domain = [-dom dom -dom dom -dom dom];
    ph1= patch(pcontour3(C1,0,domain,'c')); set(ph1, 'FaceColor', 'none', 'EdgeColor', 'k' );
    ph2= patch(pcontour3(C2,0,domain,'c')); set(ph2, 'FaceColor', 'none', 'EdgeColor', 'k' );
    ph3= patch(pcontour3(C3,0,domain,'c')); set(ph3, 'FaceColor', 'none', 'EdgeColor', 'k' );
    ph4= patch(pcontour3(C4,0,domain,'c')); set(ph4, 'FaceColor', 'none', 'EdgeColor', 'k' );
    phV0= patch(pcontour3(V0,double(C0),domain,'G')); set(phV0,'EdgeAlpha',1, 'FaceColor', 'none', 'EdgeColor', 'g' );
    phB= patch(pcontour3(B,0,domain,'B')); set(phB,'EdgeAlpha',1,'FaceColor', 'none', 'EdgeColor', 'b','LineStyle','-','LineWidth',1);
    xlim([-dom dom]); ylim([-dom dom]); zlim([-dom dom]); view(-30,20);
    %%
    figure(figure_id+1);clf;hold on;
    phV0= patch(pcontour3(V0,double(C0),domain,'G')); set(phV0,'EdgeAlpha',1, 'FaceColor', 'none', 'EdgeColor', 'g' );
    %% Hyperparameters of the SOSP @ CBF -> V
    figure(figure_id);hold on;
    V_us = 4; V_au = 4; V_degree = 4; gamma = 0; k_u_V = 4; k_l_au = 4;
    % V_us = 6; V_au = 6; V_degree = 6; gamma = 0; k_u_V = 6; k_l_au = 6;
    % V_us = 8; V_au = 8; V_degree = 8; gamma = 0; k_u_V = 8; k_l_au = 8;
    %%
    kk = 1; OO = 0;
    %%
    [V, kk] = sos_optimal_V1_3D(f,gg,B,u1,u2,u3,V_au,V_us,V_degree,C,gamma);
    %%
    if kk == 0
        fprintf('Suitable Lyapunov function can not find.======\n');
    end
    N_Lya = [N_Lya;V];
    %% TEST FOR Sublevel Set
    [a1,b1] = coeffs(p2s(V));
    ccc = double(vpa(a1(end)));
    C0 = ccc; cc = ccc+1;solU = []; v_c = []; iter = 0;
    %%
    figure(figure_id);hold on;
    phV1= patch(pcontour3(V,double(cc),domain,'G')); set(phV1,'EdgeAlpha',1, 'FaceColor', 'none', 'EdgeColor', 'r' );
    %%
    while double(cc)-double(C0) >= epsi
        iter = iter + 1;
        if iter ~= 0
            C0 = cc;
        end
        [solL,kk]= sos_optimal_v2_3D(f,gg,k_u_V,k_l_au,V,cc);
        if kk == 0
            break
        end
        [cc,kk,solu1,solu2,solu3] = sos_optimal_v3_3D(f,gg,k_u_V,k_l_au,V,C,dom,solL,ccc,figure_id);
        v_c = [v_c; double(cc)]
        solU = [solU;[solu1,solu2,solu3]];
    end
    %% Start to compute the control barrier function
    c_b = v_c(end);
    sol_B = c_b - N_Lya(end);
    hold on;
    phsol_B= patch(pcontour3(sol_B,0,domain,'B')); set(phsol_B,'EdgeAlpha',1,'FaceColor', 'none', 'EdgeColor', 'r','LineStyle','-','LineWidth',1);
    figure(figure_id+1);hold on;
    phsol_B= patch(pcontour3(sol_B,0,domain,'B')); set(phsol_B,'EdgeAlpha',1,'FaceColor', 'none', 'EdgeColor', 'r','LineStyle','-','LineWidth',1);
    xlim([-dom dom]); ylim([-dom dom]); zlim([-dom dom]); view(-30,20);
    V = N_Lya(end);
end