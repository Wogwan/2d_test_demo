clear;tic;
pvar x1 x2 x3 u htol epsi;
format long;
x = [x1;x2;x3];
dom = 10; domain = [-dom dom -dom dom -dom dom];
figure_id = 300;
%%
C1 = (x1-3)^2+(x2-0)^2+(x3-0)^2-2;
C2 = (x1+3)^2+(x2+3)^2+(x3-3)^2-3;
C3 = (x1-0)^2+(x2-3)^2+(x3+0)^2-3;
C4 = (x1-3)^2+(x2-0)^2+(x3+3)^2-3;
C = [C2;C3;C4];
V00 = 1*x1^4+1*x2^4+1*x3^4+1*x1^2*x2^2+1*x3^2*x2^2+1*x1^2*x3^2;
CC0 = 2.584683714740699;
%%
Compute = {};
f = [-0.16211179709695037165964324641892*x1^4+0.49031898059485488031675707268867*x1^3-0.80741059860165544525334054266171*x1^2-0.67918469453797989758096302163419*x1-0.000031796033448678815965058458425929*x2^4+0.00049811603934539429219124917480599*x2^3-0.017884574789259536503616132563366*x2^2+0.059003602596920091960530641017613*x2+0.14736298331076760903535216584714*x3^4-0.22234685217253638556123007674614*x3^3+0.14008297734444075111071015271591*x3^2+0.34076230832989312657943514750514*x3-1.4865840251194628709408125437986
    -x2*x1^3-x2
    1.876321954439673866943394386908*x1^4-1.8803947547684580765547934788628*x1^3-x1^2*x3-0.3521313244010295662178577913437*x1^2-0.58570314276461321600919518459705*x1+0.0008606977977094753011130801034767*x2^4-0.0047246616639717428295930368165045*x2^3+0.0073970075005580443808228530144788*x2^2-0.39277632595769917944750204696902*x2-0.63399852647351906398398568853736*x3^4-2.3526877462367330462456038731034*x3^3-0.18912599086086179234200699283974*x3^2-1.2624646738177363047839207865763*x3+1.2361363889678920191528277428006
    ];
gg = [1;1;1];
%%
trace_Q1 = 1; trace_Q = 0;
mm = 0; kk = 1;
%%
k_u = 4; k_h = 4; L_us = 4; L_au = 4; gamma = 0;
%%
figure(figure_id);clf;hold on;xlim([-dom dom]); ylim([-dom dom]); zlim([-dom dom]);
%% Original Version
% V = 1.10781433271431*x1^4+0.01711562498101607*x1^3*x2-0.004293891357695184*x1^3*x3-1.819455621599063*x1^2*x2^2-0.07835130081009554*x1^2*x2*x3+0.2005455165134622*x1^2*x3^2+0.005854541235984267*x1*x2^3-0.1053988557975258*x1*x2^2*x3+0.104687646024595*x1*x2*x3^2-0.01576905880117915*x1*x3^3+1.124505629451759*x2^4-0.04474629485339712*x2^3*x3+0.2312786612293422*x2^2*x3^2-0.01730554792698724*x2*x3^3+0.121312765683126*x3^4+0.01156354899908827*x1^3-0.07535038403941373*x1^2*x2-0.01488159063399457*x1^2*x3-0.08501506578247583*x1*x2^2+0.08355970214331113*x1*x2*x3-0.01717793720821389*x1*x3^2+0.01319142674040484*x2^3-0.03173064799350401*x2^2*x3+0.0003880888277869219*x2*x3^2-0.02016579874197291*x3^3+0.3883270529776856*x1^2+0.01952597427976192*x1*x2-0.05128081802475131*x1*x3+0.3766506193975706*x2^2-0.0969329568996595*x2*x3+0.4210891700128911*x3^2+8.835240134064381e-05*x1+0.0003560022249767095*x2-0.0002817478469884745*x3+6.770626500902747;
% C0 = 10.296886492629705;
%%
V = 0.00018764378610349287997832723462466*x2 - 0.00011334824870748086552904587698265*x1 - 0.000051579063125772460669804519994841*x3 + 0.47396687159406852840604074117437*x1^2*x2^2 + 0.67910627168687853760786765633384*x1^2*x3^2 + 0.691308006775196548510109550989*x2^2*x3^2 - 0.037717243012381475308902878396111*x1*x2 + 0.055634193401620332664059276339685*x1*x3 + 0.025013756898290058494627174923153*x2*x3 + 0.020349894788169099746344414825217*x1*x2^2 + 0.048764940259635243535729642871956*x1^2*x2 - 0.016353316606517964010292232046595*x1*x2^3 - 0.0059800256303151238038151582543378*x1*x3^2 + 0.00099175193381190814186088022808008*x1^2*x3 - 0.016274783191877063848185258621015*x1^3*x2 + 0.013261904649602597114355084784165*x1*x3^3 + 0.0051767724584444894594947861321543*x2*x3^2 + 0.018094660762113537466611035142705*x1^3*x3 - 0.0058763689341596644227783130531861*x2^2*x3 + 0.0090100987584495959015207233733236*x2*x3^3 + 0.013813284027108786028437137360925*x2^3*x3 + 1.8789284666601038242816912315902*x1^2 + 0.0057103050122911287733717955461543*x1^3 + 1.8849817604057241826609470081166*x2^2 + 0.89932379254279937175198256227304*x1^4 + 0.030989153264756874595065028188401*x2^3 + 0.74293797491860946724528957929579*x3^2 + 0.92162091215513963771144290149095*x2^4 + 0.00028837730226974697287853355298637*x3^3 + 0.38625240406278110727456009954039*x3^4 - 0.0055677688688991981008635789862637*x1*x2*x3^2 + 0.016053098885876509321901650650943*x1*x2^2*x3 + 0.0099681337524746838063549603248248*x1^2*x2*x3 - 0.0049968596555885255033890857134793*x1*x2*x3 + 12.588652094649772195111836481374;
C0 = 18.06442393618570;
%%
sol_B = C0 - V; solh = sol_B;
TRACE = []; Barrier = []; Control = []; iter = 0;
%%
while 1
    figure_id = figure_id+1;
    figure(figure_id);clf;
    B1 = 0.0000049328582307157311069990661411833*x1 - 0.000019068981119903366245986464644346*x2 + 0.000014102603560927048421437535186129*x3 + 10.0404287986786115993709245231*x1^2*x2^2 + 1.6605617858776455797453763807425*x1^2*x3^2 + 1.476476964467124286528587617795*x2^2*x3^2 + 0.00095371308734639359452195384037054*x1*x2 - 0.00045868124679334932843402516944309*x1*x3 - 0.013515976353731617640163698013112*x2*x3 - 0.019215648720721067999051001606858*x1*x2^2 - 0.019321828473837125011991489031971*x1^2*x2 - 0.0038223525849330245406088035764469*x1*x2^3 + 0.012260579458483369941212970388733*x1*x3^2 - 0.0031438347178009088539463178335609*x1^2*x3 - 0.0055565827969806030547927910845374*x1^3*x2 - 0.0056163817415686686021492057818705*x1*x3^3 + 0.037023803979067744507336357173699*x2*x3^2 + 0.0077139601111593592355775150792851*x1^3*x3 + 0.0078595269304306235313983819423811*x2^2*x3 - 0.004862829817166020550389671228686*x2*x3^3 + 0.0073510171915708577561332504046732*x2^3*x3 - 0.095056527044026548067812143472111*x1^2 - 0.012378923636273322234080396242462*x1^3 - 0.15260657361929283459822670465655*x2^2 - 6.0661002131129846404178351804148*x1^4 - 0.019205022658502234056410173934637*x2^3 - 0.64145052323826734497203005957999*x3^2 - 5.9732230912243213793999530025758*x2^4 - 0.0012824119850375723540097938624172*x3^3 - 1.6792252968286556225052663648967*x3^4 + 0.0070459372583660034514152492590711*x1*x2*x3^2 + 0.013451185556427696504711022384981*x1*x2^2*x3 + 0.0088378774054591359432553332453608*x1^2*x2*x3 + 0.000402133456836332265835198818138*x1*x2*x3 + 12.419274592944972823715943377465;
    inV = patch(pcontour3(B1,0,domain,'b'));
    set(inV,'EdgeAlpha',0.1,'FaceColor', 'none', 'EdgeColor', 'r','LineStyle','-','LineWidth',0.6); hold on;
    ph2= patch(pcontour3(C2,0,domain,'c')); set(ph2, 'FaceColor', 'none', 'EdgeColor', 'k' );
    ph3= patch(pcontour3(C3,0,domain,'c')); set(ph3, 'FaceColor', 'none', 'EdgeColor', 'k' );
    ph4= patch(pcontour3(C4,0,domain,'c')); set(ph4, 'FaceColor', 'none', 'EdgeColor', 'k' );
    phV0= patch(pcontour3(V,double(C0),domain,'G')); set(phV0,'EdgeAlpha',1, 'FaceColor', 'none', 'EdgeColor', 'g','LineStyle','-','LineWidth',1);
    %%
    iter = iter+1
    record_Q = trace_Q
    %%
    [SOLu1,SOLu2,SOLu3,SOL1,SOL2,kk] = sos_function_1_3D(f,k_u,L_au,solh,V,gamma,gg);
    Control = [Control; [SOLu1 SOLu2 SOLu3]];
    if kk == 0
        break
    end
    %%
    [solh,trace_Q,kk] = sos_function_2_3D(iter,f,k_h,SOLu1,SOLu2,SOLu3,SOL1,SOL2,gamma,V,C,dom,gg,L_us,figure_id);
    TRACE = [TRACE; double(trace_Q)];
    Barrier = [Barrier; solh];
    if kk == 0
        break
    end
end
view(-121,-10);
%%
fprintf('Optimal $B(x)$ is \n%s \n\n',char(vpa(p2s(Barrier(end-1)))));
toc